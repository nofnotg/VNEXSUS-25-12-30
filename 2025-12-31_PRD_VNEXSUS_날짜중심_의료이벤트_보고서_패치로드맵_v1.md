# 2025-12-31 PRD — VNEXSUS 날짜중심 의료이벤트·보고서 안정화 (v1)

## 0) 목적과 원칙

### 목적
Vision OCR로 추출된 **텍스트 + 좌표(블록/라인/단어)** 정보를 활용해, 비정형 의료문서를 **‘정확한 날짜’ 기반의 의료이벤트**로 재구성하고, 이를 바탕으로 **9~10 항목 보고서**가 “끊기지 않고” 출력되도록 안정화한다.

### 절대 원칙 (운영/법무 리스크 방지)
- 시스템은 **판단(지급/면책/위반 확정)**을 하지 않는다.
- 출력은 **객관적 사실 정리 + 근거(출처/페이지/좌표/원문 인용 최소)** 중심이며,
  “가능성/확인요망/추가서류 필요” 수준의 코멘트만 허용한다.

### Non-Goals (이번 패치에서 제외)
- Textract/Tesseract/AWS 연동 고도화: **사용하지 않으므로 제거 대상**
- ‘결론/판정’ 자동화: **의도적으로 제외**

---

## 1) 입력/출력 정의

### 1-1. 입력(표준화 전제)
- 문서 단위: PDF(스캔/텍스트 혼재 가능)
- OCR 결과: Vision OCR
  - 텍스트(전체/페이지별)
  - 좌표 정보(페이지 번호, bounding box, 블록/라인/단어 단위)
  - 신뢰도(confidence)
- (옵션) 보험계약 정보: contract_date, product windows(예: 3m/2y/5y), 청구병명/담보

### 1-2. 출력(표준화된 2단 구조)
- **A. 확장형(Full Report)**: 날짜별 의료이벤트 리스트 + 근거/메타 포함
- **B. 결재용 요약본**: 9~10 항목의 “고정 틀”로 핵심만 압축

---

## 2) 9~10 항목 보고서 템플릿(고정) — “정보 제한은 하지 않되, 틀만 고정”

본 항목은 ‘고정 슬롯’이고, 각 슬롯 내부에는 문맥상 필요한 정보를 **충분히** 포함할 수 있다.
(예: 검사결과는 영상/정밀검사 중심이지만, 의사소견에서 혈액수치가 핵심이면 포함 가능)

### 2-1. 단일 의료이벤트(날짜 1개에 바인딩된 이벤트) 10개 항목
1. **내원일시(또는 시행일)**: yyyy.mm.dd (필요 시 시간/기간 병기)
2. **내원경위**: 증상/의뢰/검진 후 추적/응급내원 등 배경 요약
3. **진단병명**: KCD/ICD 코드 + 영문 + 한글 (가능하면 병기)
4. **검사결과**: 검사명/검사일/주요 소견(원문+한글 병기, 필요 시 보고일 포함)
5. **수술 후 조직검사 결과(해당 시)**: 검사일/보고일/조직소견/TNM 등
6. **치료내용**: 수술/시술/처치/약물/항암·방사선 등
7. **통원기간**: yyyy.mm.dd ~ yyyy.mm.dd / n회 (또는 단일 내원)
8. **입원기간**: yyyy.mm.dd ~ yyyy.mm.dd / n일 (해당 시)
9. **과거병력**: 문서에서 확인되는 범위 내 “관련” 과거력 요약(없으면 ‘미기재’)
10. **의사소견**: 계획/추적/재검/입원·수술 필요 소견 등 핵심 문장

### 2-2. “고정 10항목” 외 확장 메타(필수 아님)
- **근거(출처)**: 페이지/좌표/원문 스니펫(25단어 이내) + confidence
- **태그**: 입원/수술/암/심혈관/뇌혈관/응급 등
- **확인요망**: 누락 가능성(예: ‘진단일 미기재’, ‘보고일만 존재’)만 표기
- **가중치/연관성**: (섹션 4 참조)

---

## 3) 핵심 엔진: “날짜 바인딩 → 이벤트 패킹” 설계

### 3-1. 날짜 바인딩(최우선, 모든 것의 출발점)
1) **날짜 후보 추출**
- 패턴 기반(YYYY.MM.DD / YYYY-MM-DD / YY.MM.DD / 한글 표기)
- 문맥 기반 키워드(내원일/수술일/검사일/판독일/보고일/입원일/퇴원일 등)

2) **좌표 기반 Anchoring**
- 동일 페이지에서 날짜 박스와 가까운 블록/라인을 “동일 이벤트 후보”로 묶는다.
- 테이블/헤더/푸터는 별도 룰로 제외 또는 낮은 신뢰도로 처리.

3) **이벤트 생성 규칙**
- “동일 병원 + 근접 날짜 + 동일 진단 축”은 하나의 사건으로 묶되,
  **‘날짜’는 결코 합치지 않는다**(날짜가 다르면 서로 다른 이벤트로 본다).

4) **Fallback**
- 좌표가 불충분하면 텍스트-only로 문맥 윈도우를 만들어 날짜를 연결하되,
  근거 confidence를 낮추고 “확인요망”에 남긴다.

### 3-2. 이벤트 패킹(10항목 채우기)
- 이벤트 텍스트에서 엔티티(진단/검사/처치/약/기간)를 추출해 슬롯에 채운다.
- 슬롯 채움은 “엄격한 룰”보다 “문맥을 해치지 않는 범위의 관용적 파싱”을 우선한다.
- 누락은 ‘미기재’로 남기되, 근거 텍스트가 있으면 최대한 채운다.

---

## 4) 가중치(소수점) & 연관성(민감도 조정)

### 4-1. 목적
- ‘판단’이 아니라, 조사자가 빠르게 훑도록 **우선순위/연결성 힌트**를 제공한다.

### 4-2. 산식(권장: 0.000~1.000)
- `score = sigmoid( Σ (w_i * f_i) )` 후 소수점 3자리로 표시
- 기본 피처 예시:
  - f1: event_type_severity (입원/수술/암확진/응급 등)
  - f2: temporal_proximity_to_contract (가입일과의 거리; 가까울수록 ↑)
  - f3: documentation_strength (조직검사/영상/수술기록 > 진료기록 > 처방전)
  - f4: claim_relevance (청구병명/담보와의 연관)
  - f5: repetition_pattern (동일 진단 반복·연속성)
  - f6: explicit_disclosure_trigger (입원필요/수술필요/추가검사 필요 소견 등)

### 4-3. 연관성 그래프(권장)
- 이벤트 간 엣지 점수 `rel = 0.000~1.000`:
  - 동일 진단군/기관/부위
  - 동일 검사(CT/MRI 등) 연쇄
  - 시간 간격이 짧음
- 출력은 예: “연관 이벤트: {YYYY.MM.DD}, {YYYY.MM.DD} (rel=0.732)”처럼 표시

---

## 5) RAG 확장(웹 보완 → 1회성 금지 → 지속 축적)

### 5-1. 즉시 효용이 큰 RAG 대상
- ICD/KCD 코드 ↔ 영문명 ↔ 한글명
- 검사 약어(CT-Angio, EGD, Holter 등) 표준화
- 병원명/진료과/처치 코드 간단 사전

### 5-2. 동작 원칙
- 보고서 생성 중 “필수 표기(영문/한글 병기 등)”가 충족되지 않으면:
  1) 로컬 RAG/DB 조회
  2) 미존재 시 웹 조회(1회)
  3) 결과를 RAG에 **자동 적재(추가/확장)**
- 적재는 출처 URL/날짜/신뢰도 메타를 함께 저장(추적 가능성 확보)

---

## 6) 정리(경량화) — 기능 영향 없이 걷어낼 것

### 6-1. 제거 대상
- AWS/Textract/Tesseract 관련 코드/설정/문서/ENV 분기
- 사용되지 않는 실험용 후처리 분기(특정 케이스 전용 룰이 누적된 부분)

### 6-2. 정리 원칙
- “코어 엔진(날짜 바인딩·이벤트 패킹·템플릿 출력)” 경로는 단일화
- 실험/프로토타입은 `/_archive` 또는 `/experiments`로 이동(빌드/배포 경로 제외)
- 테스트는 ‘표준 케이스 세트’로 집중(분산된 샘플 정리)

---

## 7) Acceptance Criteria (검증 기준)

1. **날짜 정규화 성공률**: 입력 문서에서 탐지된 날짜 후보 중
   - 파싱 성공률 99% 이상(형식 변형 포함)
2. **날짜→이벤트 바인딩 품질**: 표준 테스트셋에서
   - 핵심 이벤트(입원/수술/조직검사/영상검사) 날짜 바인딩 정확도 95% 이상
3. **보고서 출력 안정성**:
   - 10항목 템플릿이 누락 없이 출력되며(누락은 ‘미기재’ 처리),
   - HTML/Markdown/JSON 중 최소 2개 형식이 동일 스키마로 생성된다.
4. **정리(경량화) 후 회귀 없음**:
   - Vision OCR 기반 파이프라인이 동일 입력에서 동일(또는 개선된) 이벤트 수를 생성한다.

---

## 8) 패치 타이틀(날짜+타이틀)

- 2025-12-31 Patch-01 — Vision OCR Only 파이프라인 슬림화(Textract/Tesseract 제거)
- 2025-12-31 Patch-02 — 좌표 기반 Date Binding v3(테이블/헤더/푸터 분리 강화)
- 2025-12-31 Patch-03 — 10항목 보고서 템플릿/스키마 고정(Full + Summary)
- 2025-12-31 Patch-04 — 가중치·연관성 스코어링(소수점 민감도 조정)
- 2025-12-31 Patch-05 — Web→RAG 자동확장(코드/용어/검사 표준화)
- 2025-12-31 Patch-06 — 후처리 로직 정리 및 테스트 케이스 통합(경량화)

# 2026-01-02 TASKS — 불확실성 스코어(Uncertainty Score) 구현 전달용 v2
대상 레포: `nofnotg/VNEXSUS-25-12-30`  
목적: **날짜 바인딩/의료이벤트 추출 결과에 대한 “신뢰도(confidence)”와 “불확실성(uncertainty)”을 정량화**하고, 이 값을 기준으로 (1) LLM 검증 투입 여부를 결정하며 (2) 보고서 출력에서 A급/B급/확인요망을 일관되게 구성할 수 있도록 한다.  
코딩 모델: **TREA AI / GPT-5-HIGH** (본 문서는 코딩 모델이 그대로 실행 가능한 수준의 작업 정의를 목표로 함)

---

## 0) 핵심 원칙(반드시 준수)
1. **판단 금지**: 위반/면책/지급여부 등 결론 도출 로직 금지.  
   - 허용: `확인요망`, `가능성`, `추가서류 필요` 수준의 메모/플래그만.
2. **Vision OCR Only**: Textract/Tesseract/AWS OCR 경로는 본 작업 범위에서 제외(기존 코드에 남아있다면 별도 정리 패치에서 제거).
3. **불확실성 스코어의 역할은 “리스크 신호”**:  
   - “정답 판정”이 아니라 **LLM 검증/사용자 검토/후속 파이프라인 분기**를 위한 정량 신호.
4. **소수점 정밀도**: 모든 스코어는 `0.00~1.00` 범위, **소수점 2자리 고정**(UI/리포트/로그 동일).

---

## 1) 산출물(Deliverables)
- [ ] **코드**
  - `backend/services/core-engine/UncertaintyScoreCalculator.js` (신규)
  - `backend/services/core-engine/ConfidenceScorer.js` (기존, 필요 시 “호환 유지” 선에서 확장)
  - `backend/services/core-engine/enhanced/DateAnchoringOptimizer.js` (기존, 출력에 “바인딩 근거/경쟁도” 포함하도록 확장)
  - `backend/services/core-engine/ReportSynthesizer.js` (기존, 이벤트에 confidence/uncertainty/meta 포함)
  - (선택) `backend/postprocess/contextAnalyzer.js` 연동(불확실 요인 피처 제공)
- [ ] **스키마**
  - `EventConfidenceMeta` JSON 스키마 정의(문서/코드 주석 + 테스트에 사용)
- [ ] **테스트**
  - 단위 테스트(최소 15개): 스코어 범위/정밀도/엣지케이스/결정 로직
  - 통합 테스트(최소 5개): Date binding → Event packing → Report 출력까지 스코어가 안정적으로 포함되는지
- [ ] **운영 로그/모니터링(경량)**
  - 케이스별 스코어 요약 로그(성능/회귀 분석용)
  - 임계치(threshold) 설정값 외부화(config/env)

---

## 2) 정의(Definitions)
### 2.1 Confidence vs Uncertainty
- `confidence_score`: 현재 바인딩/추출 결과가 **얼마나 믿을 만한지** (높을수록 좋음)
- `uncertainty_score`: 결과에 **모호함/충돌/결측/품질저하** 요인이 얼마나 큰지 (높을수록 위험)
- 두 값은 완전 반비례가 아님(예: confidence가 높은데도 conflicting info가 있으면 uncertainty가 높을 수 있음)

### 2.2 출력 정밀도 규칙
- 모든 점수는 `Number`로 계산하되, 출력(저장/리포트)은 `toFixed(3)`로 **문자열 고정** 또는 `Math.round(x*1000)/1000`로 숫자 고정(팀 표준 중 1개 선택 후 일관 유지).

---

## 3) 통합 지점(Integration Points)
### 3.1 날짜 바인딩 단계 (DateAnchoringOptimizer)
목표: 날짜 후보(또는 날짜-블록 연결)마다
- 경쟁도(Top1 vs Top2), 근접도, 역할 키워드 적합도 등 “바인딩 근거”를 수치화하여 confidence/uncertainty 피처로 제공.

권장 출력 예시:
```json
{
  "dateCandidate": "2023-05-01",
  "binding": {
    "targetBlockId": "b_0142",
    "score_top1": 0.81,
    "score_top2": 0.78,
    "margin": 0.03,
    "competition": 0.76,
    "distance_norm": 0.12,
    "role_hint": "test",
    "signals": {
      "same_row": true,
      "same_col": false,
      "header_footer_penalty": 0.0,
      "keywords": ["검사일", "CT"]
    }
  }
}
```

### 3.2 이벤트 합성 단계 (ReportSynthesizer)
목표: 이벤트 객체에 다음 필드를 추가:
- `confidence`: {score, components, evidence}
- `uncertainty`: {score, factors}
- `reviewFlags`: {needsLLMReview, needsHumanReview, reasons[]}

---

## 4) 스코어 설계(권장 기본식)
> 구현은 “가변적”이어도 되지만, 최소 v1은 아래 기본식을 따른다(추후 가중치 튜닝 용이).

### 4.1 Confidence (0.000~1.000)
- `confidence = clamp01( Σ (w_i * component_i) )`
- component_i 예시(모듈에서 이미 존재/구현 예정):
  - `entity_extraction_quality`
  - `temporal_accuracy` (날짜 바인딩 품질)
  - `contextual_relevance`
  - `source_evidence_quality` (근거 페이지/좌표/원문 스니펫의 질)
  - `consistency_check`
  - `completeness_check` (10항목 슬롯 채움 수준; 단, “정보 제한 금지” 원칙 준수)

### 4.2 Uncertainty (0.000~1.000)
- `uncertainty = clamp01( Σ (u_j * factor_j) )`
- factor_j 예시(불확실성 요인):
  - `ambiguous_terms` (모호한 용어/약어)
  - `incomplete_data` (핵심 필드 결측, 단 “미기재” 처리)
  - `conflicting_information` (상충 날짜/상충 진단 등)
  - `low_source_quality` (OCR confidence 낮음, 레이아웃 혼잡)
  - `temporal_gaps` (연속성 추적에 불리한 공백)
  - `contextual_uncertainty` (역할키워드 부재, 테이블 파손 등)

### 4.3 LLM/인간 검토 분기(결정 로직)
- `needsLLMReview = (uncertainty >= U_LLM) OR (confidence <= C_LLM)`
- `needsHumanReview = (uncertainty >= U_HUMAN) OR (confidence <= C_HUMAN)`
- 임계치 기본값(초기 제안, config로 조정):
  - `U_LLM=0.65`, `C_LLM=0.50`
  - `U_HUMAN=0.80`, `C_HUMAN=0.35`

---

## 5) 작업 목록(구현 단위 / 코딩 모델 전달용)

## UNC-01 — 스키마 정의 및 공용 타입(문서+코드)
**목표:** 스코어/메타 필드의 스키마를 먼저 확정해 코드와 테스트의 기준으로 삼는다.  
**작업**
- [ ] `docs/schemas/event_confidence_meta.schema.json` 생성(없으면 `backend/schemas/`도 허용)
- [ ] 스키마에 아래 필드를 포함:
  - `confidence.score`, `confidence.components[]`, `confidence.evidence[]`
  - `uncertainty.score`, `uncertainty.factors[]`
  - `reviewFlags.needsLLMReview`, `reviewFlags.needsHumanReview`, `reviewFlags.reasons[]`
- [ ] README(또는 주석)로 필드 의미/범위/정밀도 명시

**Acceptance**
- [ ] 샘플 이벤트 JSON 3개가 스키마 검증 통과
- [ ] 점수 출력 소수점 2자리 고정 규칙 명시

---

## UNC-02 — UncertaintyScoreCalculator.js 신규 구현
**목표:** confidence/uncertainty 계산과 분기 플래그 산출을 단일 모듈로 제공  
**파일**
- `backend/services/core-engine/UncertaintyScoreCalculator.js` (new)

**권장 인터페이스**
```js
class UncertaintyScoreCalculator {
  constructor(config) { /* ... */ }

  // 입력: dateBindingDiagnostics, ocrMeta, extractedEntities, eventDraft
  // 출력: { confidence, uncertainty, reviewFlags }
  scoreEvent(input) { /* ... */ }

  // 헬퍼(필수)
  clamp01(x) { /* ... */ }
  round3(x) { /* ... */ }
}
module.exports = UncertaintyScoreCalculator;
```

**구현 요구**
- [ ] `scoreEvent()`는 최소 다음 입력을 받도록 설계:
  - `dateBindingDiagnostics` (top1/top2/margin/competition 등)
  - `ocrMeta` (page, ocrConfidence summary 등)
  - `extractedEntities` (진단/검사/치료/기간 등)
  - `eventDraft` (10항목 슬롯 현재 상태)
- [ ] `confidence.components[]`와 `uncertainty.factors[]`는 각각:
  - `key`, `value(0~1)`, `weight`, `contribution`, `notes?`
- [ ] `reasons[]`는 사람이 읽을 수 있는 짧은 문자열(예: `LOW_MARGIN_DATE_BINDING`, `CONFLICTING_DATES`)
- [ ] 출력은 항상 범위 내 + 소수점 2자리 고정

**Acceptance**
- [ ] 단위 테스트로 최소 10개 케이스 통과(범위/정밀도/엣지)
- [ ] 입력 데이터 일부가 없더라도(결측) crash 없이 동작하고 factor로 반영

---

## UNC-03 — ConfidenceScorer.js “호환 유지 확장”
**목표:** 레거시 호출부를 깨지 않으면서, 필요한 피처/출력 확장  
**작업**
- [ ] 기존 퍼블릭 함수 시그니처 유지
- [ ] 내부적으로 `UncertaintyScoreCalculator` 호출 가능하도록 연결(선택)
- [ ] 기존 confidence 구성요소가 있다면 `confidence.components`에 매핑

**Acceptance**
- [ ] 기존 테스트/동작 경로 회귀 없음
- [ ] 새로운 메타를 추가해도 기존 출력 소비 코드가 깨지지 않음

---

## UNC-04 — DateAnchoringOptimizer.js 진단 출력 강화
**목표:** “애매함/경쟁도”를 정량화하여 uncertainty factor로 사용  
**작업**
- [ ] 날짜-블록 바인딩 결과에 다음 필드를 추가:
  - `score_top1`, `score_top2`, `margin`, `competition`, `distance_norm`
  - `role_hint`, `layout_zone_penalty`
- [ ] competition 계산 권장:
  - `competition = 1 - clamp01(margin / marginNorm)` (margin 작을수록 competition↑)
- [ ] 헤더/푸터/테이블 파손 영역을 감지하면 penalty 신호 제공

**Acceptance**
- [ ] 바인딩 결과에 진단 필드가 항상 포함됨(최소값/기본값으로라도)
- [ ] margin=0에 대한 방어(division-by-zero 등) 처리

---

## UNC-05 — ReportSynthesizer.js 이벤트 메타 주입
**목표:** 보고서 생성 시 event 객체에 confidence/uncertainty/reviewFlags가 포함되도록 한다.  
**작업**
- [ ] 이벤트 합성 파이프라인에서 `UncertaintyScoreCalculator.scoreEvent()` 호출
- [ ] A급/B급/확인요망 분류는 다음 정책으로(초기 v1):
  - `A`: weight>=0.70 또는 (confidence>=0.65 && uncertainty<=0.45)
  - `B`: 그 외지만 이벤트는 보존(삭제 금지)
  - `확인요망`: `needsHumanReview==true` 또는 date role unknown + competition high
- [ ] 보고서 출력(HTML/MD/JSON)에서:
  - A급은 10항목 슬롯을 우선 렌더
  - B급은 축약 리스트(날짜/진단/검사/치료/근거 링크)로 제공
  - 확인요망은 “이유 코드 + 근거”만 간결히

**Acceptance**
- [ ] 기존 보고서 생성이 깨지지 않음
- [ ] 출력 JSON에 meta가 포함되고, 렌더링이 정상

---

## UNC-06 — 구성값(config) 외부화
**목표:** 임계치/가중치가 코드 하드코딩이 아니라 설정으로 조정 가능  
**작업**
- [ ] `config/uncertaintyScore.config.json` 또는 `.env` 기반 설정 도입
- [ ] 최소 설정 항목:
  - component weights, factor weights
  - U_LLM, C_LLM, U_HUMAN, C_HUMAN
  - rounding mode(숫자/문자열)
- [ ] 설정 누락 시 default fallback 제공

**Acceptance**
- [ ] 설정 변경으로 분기 결과가 바뀌는 것을 테스트로 확인

---

## UNC-07 — 테스트/골든 세트 구축
**목표:** 회귀 방지. “날짜 바인딩”이 흔들리면 즉시 감지.  
**작업**
- [ ] `tests/fixtures/date_binding_cases/` (최소 10개 JSON fixture)
- [ ] `tests/fixtures/events/` (최소 10개 eventDraft + expected meta)
- [ ] 테스트 유형:
  - margin 낮을 때 uncertainty 증가
  - conflicting dates 있을 때 uncertainty 증가
  - OCR confidence 낮을 때 low_source_quality 증가
  - 결측 필드가 있을 때 incomplete_data 증가
- [ ] 스냅샷 또는 diff 테스트로 score 변화 감지(허용 오차 0.005 등)

**Acceptance**
- [ ] CI에서 재현 가능(랜덤 요소 제거)
- [ ] 테스트가 “결정 로직(needsLLMReview)”까지 검증

---

## UNC-08 — 운영 로그(경량) 및 디버그 리포트
**목표:** 현장 케이스에서 왜 uncertainty가 높은지 바로 추적  
**작업**
- [ ] 케이스 처리 후 JSON 로그 생성(옵션):
  - `case_id`, `events_count`, `avg_confidence`, `avg_uncertainty`
  - top reasons distribution
- [ ] debug mode에서 “바인딩 경쟁도 상위 10개” 출력

**Acceptance**
- [ ] 로그가 개인정보/판단 문구를 포함하지 않도록 주의(객관 데이터+코드만)

---

## 6) Definition of Done (완료 기준)
- [ ] 이벤트 단위로 confidence/uncertainty가 항상 계산되어 출력에 포함됨
- [ ] `needsLLMReview` 플래그가 안정적으로 산출되고 임계치로 조정 가능
- [ ] 스코어는 `0.00~1.00`, 소수점 2자리, NaN/Infinity 없음
- [ ] 기존 리포트 생성 및 파이프라인 회귀 없음
- [ ] 단위/통합 테스트 통과 + fixture 기반 회귀 감지 가능

---

## 7) 코딩 AI 실행 지침(붙여넣기용)
1. 브랜치 생성: `feat/uncertainty-score-v1`
2. 변경 파일:
   - add: `backend/services/core-engine/UncertaintyScoreCalculator.js`
   - edit: `backend/services/core-engine/ConfidenceScorer.js`
   - edit: `backend/services/core-engine/enhanced/DateAnchoringOptimizer.js`
   - edit: `backend/services/core-engine/ReportSynthesizer.js`
   - add: `config/uncertaintyScore.config.json`
   - add: `tests/...`
3. 테스트 실행:
   - `npm test` 또는 레포의 테스트 명령(없으면 `node tests/run.js` 형태로 간단 러너 추가)
4. PR 체크:
   - score 출력이 소수점 2자리인지 확인
   - 보고서에서 A/B/확인요망 섹션이 생성되는지 확인

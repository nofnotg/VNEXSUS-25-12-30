<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Investigator View - VNEXSUS</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ•µï¸</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

  <!-- PDF.js (Mozilla, Apache 2.0) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <link rel="stylesheet" href="src/components/InvestigatorView/InvestigatorView.css">

  <style>
    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --sidebar-w: 260px;
      --pdf-panel-w: 480px;
      --header-h: 54px;
      --accent: #0d6efd;
    }

    html, body { height: 100%; margin: 0; overflow: hidden; }

    body {
      display: grid;
      grid-template-rows: var(--header-h) 1fr;
      grid-template-columns: var(--sidebar-w) 1fr var(--pdf-panel-w);
      grid-template-areas:
        "header header header"
        "sidebar timeline pdf";
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6fa;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app-header {
      grid-area: header;
      background: #1a2236;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      gap: 1rem;
      z-index: 100;
      box-shadow: 0 2px 6px rgba(0,0,0,.3);
    }
    #app-header h1 { font-size: 1.1rem; margin: 0; }
    #case-selector { background: #2a3550; border: 1px solid #3a4a6a; color: #fff; border-radius: 6px; padding: 4px 8px; font-size: .85rem; }
    #case-selector option { background: #1a2236; }

    /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #sidebar {
      grid-area: sidebar;
      background: #fff;
      border-right: 1px solid #dee2e6;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .sidebar-hd {
      padding: .5rem .75rem;
      font-size: .75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: #6c757d;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      flex-shrink: 0;
    }
    #event-list { flex: 1; overflow-y: auto; }
    .ev-item {
      padding: .5rem .75rem;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background .15s;
    }
    .ev-item:hover { background: #eef4ff; }
    .ev-item.selected { background: #dbeafe; border-left: 3px solid var(--accent); }
    .ev-item.has-source::after {
      content: 'ğŸ“';
      float: right;
      font-size: .75rem;
      opacity: .7;
    }
    .ev-date { font-size: .78rem; font-weight: 700; color: var(--accent); }
    .ev-hospital { font-size: .82rem; color: #333; margin: 2px 0; }
    .ev-type { font-size: .72rem; color: #6c757d; }
    /* ê¸°ê°„ ë°°ì§€ */
    .vnx-period-badge {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 10px;
      font-size: .68rem;
      font-weight: 700;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* â”€â”€ Timeline (center) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #timeline-area {
      grid-area: timeline;
      overflow-y: auto;
      padding: 1rem;
    }
    .tl-event {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: .75rem 1rem;
      margin-bottom: .65rem;
      cursor: pointer;
      transition: box-shadow .15s, border-color .15s;
      position: relative;
    }
    .tl-event:hover { box-shadow: 0 2px 8px rgba(13,110,253,.15); border-color: var(--accent); }
    .tl-event.selected { border-color: var(--accent); background: #f0f7ff; }
    .tl-event.has-source { border-left: 4px solid #198754; }
    .tl-date { font-size: .8rem; font-weight: 700; color: var(--accent); /* ë™ì  ìƒ‰ìƒì€ JSì—ì„œ inline styleë¡œ ì ìš© */ }
    .tl-hospital { font-weight: 600; color: #212529; }
    .tl-type-badge { font-size: .72rem; background: #e9ecef; color: #495057; padding: 1px 7px; border-radius: 12px; }
    .tl-summary { font-size: .85rem; color: #555; margin-top: .25rem; }
    .tl-source-btn {
      position: absolute; right: .75rem; top: 50%; transform: translateY(-50%);
      background: #198754; color: #fff; border: none; border-radius: 5px;
      font-size: .72rem; padding: 3px 8px; cursor: pointer;
      opacity: 0; transition: opacity .2s;
    }
    .tl-event.has-source:hover .tl-source-btn { opacity: 1; }
    .tl-source-btn:hover { background: #157347; }

    /* â”€â”€ PDF Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #pdf-panel {
      grid-area: pdf;
      background: #2d2d2d;
      display: flex;
      flex-direction: column;
      border-left: 1px solid #444;
      min-width: 0;
    }
    #pdf-toolbar {
      background: #1a1a1a;
      color: #ccc;
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .35rem .6rem;
      flex-shrink: 0;
      font-size: .8rem;
    }
    #pdf-toolbar button {
      background: #333; color: #ccc; border: 1px solid #555;
      border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: .78rem;
    }
    #pdf-toolbar button:hover { background: #444; color: #fff; }
    #pdf-toolbar button:disabled { opacity: .4; cursor: default; }
    #pdf-file-selector { background: #2a2a2a; color: #ccc; border: 1px solid #555; border-radius: 4px; padding: 2px 6px; font-size: .76rem; max-width: 140px; }
    #pdf-page-info { margin-left: auto; white-space: nowrap; }
    #pdf-scroll { flex: 1; overflow-y: auto; overflow-x: auto; display: flex; flex-direction: column; align-items: center; padding: .5rem 0; }
    #pdf-canvas-wrap {
      position: relative;
      display: inline-block;
      margin: auto;
    }
    #pdf-canvas { display: block; background: #fff; }
    #pdf-highlight-overlay {
      position: absolute; top: 0; left: 0;
      pointer-events: none;
    }
    #pdf-placeholder {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      color: #888; gap: .5rem;
    }
    #pdf-placeholder i { font-size: 3rem; }
    #pdf-loading {
      flex: 1; display: flex; align-items: center; justify-content: center; color: #ccc;
    }
  </style>
</head>

<body>

<!-- â”€â”€ Header â”€â”€ -->
<header id="app-header">
  <h1><i class="bi bi-clipboard-pulse me-2"></i>Investigator View â€” VNEXSUS</h1>
  <div class="d-flex align-items-center gap-2">
    <label for="case-selector" style="font-size:.82rem;white-space:nowrap;">ì¼€ì´ìŠ¤ ì„ íƒ:</label>
    <select id="case-selector">
      <option value="">-- ì¼€ì´ìŠ¤ ì„ íƒ --</option>
    </select>
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-sm btn-outline-light" onclick="window.location.href='/'"><i class="bi bi-house me-1"></i>í™ˆ</button>
  </div>
</header>

<!-- â”€â”€ Sidebar: Event List â”€â”€ -->
<aside id="sidebar">
  <div class="sidebar-hd">ì´ë²¤íŠ¸ ëª©ë¡ <span id="ev-count" class="ms-1 text-muted fw-normal" style="font-size:.7rem;">(0)</span></div>
  <div id="event-list">
    <div class="text-center text-muted p-4" style="font-size:.85rem;">ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
  </div>
</aside>

<!-- â”€â”€ Center: Timeline â”€â”€ -->
<main id="timeline-area">
  <div class="text-center text-muted mt-5" id="tl-placeholder">
    <i class="bi bi-calendar3" style="font-size:2.5rem;opacity:.4;"></i>
    <p class="mt-2">ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•˜ë©´ íƒ€ì„ë¼ì¸ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
  </div>
  <div id="timeline-events"></div>
</main>

<!-- â”€â”€ Right: PDF Viewer â”€â”€ -->
<section id="pdf-panel">
  <div id="pdf-toolbar">
    <select id="pdf-file-selector" title="PDF íŒŒì¼ ì„ íƒ"></select>
    <button id="btn-prev-page" title="ì´ì „ í˜ì´ì§€"><i class="bi bi-chevron-left"></i></button>
    <button id="btn-next-page" title="ë‹¤ìŒ í˜ì´ì§€"><i class="bi bi-chevron-right"></i></button>
    <span id="pdf-page-info">â€”</span>
    <button id="btn-zoom-out" title="ì¶•ì†Œ">âˆ’</button>
    <button id="btn-zoom-in" title="í™•ëŒ€">+</button>
    <button id="btn-zoom-fit" title="ë„ˆë¹„ ë§ì¶¤" style="padding:2px 6px;">â†”</button>
  </div>

  <div id="pdf-scroll">
    <div id="pdf-placeholder">
      <i class="bi bi-file-earmark-pdf"></i>
      <span>ì´ë²¤íŠ¸ë¥¼ í´ë¦­í•˜ë©´ PDF ì›ë³¸ì„ í‘œì‹œí•©ë‹ˆë‹¤</span>
    </div>
    <div id="pdf-loading" style="display:none;">
      <div class="spinner-border text-light" role="status" style="width:2rem;height:2rem;">
        <span class="visually-hidden">Loading PDF...</span>
      </div>
    </div>
    <div id="pdf-canvas-wrap" style="display:none;">
      <canvas id="pdf-canvas"></canvas>
      <canvas id="pdf-highlight-overlay"></canvas>
    </div>
  </div>
</section>

<!-- â”€â”€ Scripts â”€â”€ -->
<script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PDF.js ì›Œì»¤ ì„¤ì •
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìƒíƒœ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let state = {
    caseId: null,
    caseMeta: null,         // { events, pdfFiles, statistics, ... }
    selectedEvent: null,

    pdfDoc: null,
    pdfFileIndex: 0,
    currentPage: 1,
    totalPages: 0,
    zoom: 1.0,              // scale
    pendingHighlight: null, // { page, bbox:{xMin,yMin,xMax,yMax} }
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DOM refs
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const caseSelector    = document.getElementById('case-selector');
  const evCount         = document.getElementById('ev-count');
  const eventList       = document.getElementById('event-list');
  const tlPlaceholder   = document.getElementById('tl-placeholder');
  const tlEvents        = document.getElementById('timeline-events');
  const pdfFileSelector = document.getElementById('pdf-file-selector');
  const pdfPageInfo     = document.getElementById('pdf-page-info');
  const pdfPlaceholder  = document.getElementById('pdf-placeholder');
  const pdfLoading      = document.getElementById('pdf-loading');
  const pdfCanvasWrap   = document.getElementById('pdf-canvas-wrap');
  const pdfCanvas       = document.getElementById('pdf-canvas');
  const pdfHighlight    = document.getElementById('pdf-highlight-overlay');
  const btnPrev         = document.getElementById('btn-prev-page');
  const btnNext         = document.getElementById('btn-next-page');
  const btnZoomIn       = document.getElementById('btn-zoom-in');
  const btnZoomOut      = document.getElementById('btn-zoom-out');
  const btnZoomFit      = document.getElementById('btn-zoom-fit');

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì´ˆê¸°í™”: ì¼€ì´ìŠ¤ ëª©ë¡ ë¡œë“œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function initCaseList() {
    try {
      const res = await fetch('/api/pdf/cases');
      const data = await res.json();
      if (!data.success) return;

      data.cases
        .filter(c => c.hasPipelineResult || c.pdfCount > 0)
        .sort((a, b) => a.caseId - b.caseId)
        .forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.caseId;
          const tag = c.hasPipelineResult ? 'âœ…' : 'ğŸ“„';
          opt.textContent = `${tag} Case${c.caseId} â€” ${c.folderName} (PDF ${c.pdfCount}ê°œ)`;
          caseSelector.appendChild(opt);
        });

      // URL íŒŒë¼ë¯¸í„°ë¡œ ì¼€ì´ìŠ¤ ìë™ ì„ íƒ
      const params = new URLSearchParams(window.location.search);
      const preCase = params.get('case');
      if (preCase) {
        caseSelector.value = preCase;
        loadCase(preCase);
      }
    } catch (e) {
      console.error('ì¼€ì´ìŠ¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì¼€ì´ìŠ¤ ë¡œë“œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadCase(caseId) {
    state.caseId = caseId;
    state.caseMeta = null;
    state.selectedEvent = null;

    tlPlaceholder.style.display = 'none';
    tlEvents.innerHTML = '<div class="text-center text-muted py-4"><span class="spinner-border spinner-border-sm me-2"></span>ë¡œë“œ ì¤‘...</div>';
    eventList.innerHTML = '<div class="text-center text-muted py-4" style="font-size:.82rem;">ë¡œë“œ ì¤‘...</div>';

    try {
      const res = await fetch(`/api/pdf/${caseId}/meta`);
      const data = await res.json();
      if (!data.success) throw new Error(data.error);

      state.caseMeta = data;
      renderSidebar(data);
      renderTimeline(data);
      setupPdfFileSelector(data.pdfFiles || []);

      // URL íŒŒë¼ë¯¸í„°ë¡œ í˜ì´ì§€/bbox ìë™ ì´ë™
      const params = new URLSearchParams(window.location.search);
      const page = parseInt(params.get('page'));
      const bboxStr = params.get('bbox');
      if (data.pdfFiles && data.pdfFiles.length > 0) {
        await loadPdf(0, page > 0 ? page : 1, bboxStr ? parseBbox(bboxStr) : null);
      }
    } catch (e) {
      tlEvents.innerHTML = `<div class="alert alert-danger m-3">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
      console.error(e);
    }
  }

  function parseBbox(str) {
    const [xMin, yMin, xMax, yMax] = str.split(',').map(Number);
    return { xMin, yMin, xMax, yMax };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 3M/5Y ê¸°ê°„ ë¶„ë¥˜ í—¬í¼
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const PERIOD_COLOR = {
    within_3months: { primary: '#ef4444', secondary: '#fee2e2', text: '#b91c1c', border: '#fca5a5', badge: 'ğŸ”´', label: '3M' },
    within_5years:  { primary: '#f97316', secondary: '#ffedd5', text: '#c2410c', border: '#fdba74', badge: 'ğŸŸ ', label: '5Y' },
    before_5years:  { primary: '#6c757d', secondary: '#e2e3e5', text: '#383d41', border: '#d6d8db', badge: 'âš«', label: '5Y+' },
    post_enroll:    { primary: '#198754', secondary: '#d1e7dd', text: '#0a3622', border: '#a3cfbb', badge: 'ğŸŸ¢', label: 'ê°€ì…í›„' },
    unknown:        { primary: '#6c757d', secondary: '#e2e3e5', text: '#383d41', border: '#d6d8db', badge: 'â“', label: '?' },
  };

  function getEventPeriod(ev, enrollDate) {
    if (!ev.date || !enrollDate) return 'unknown';
    const d = new Date(ev.date);
    if (isNaN(d)) return 'unknown';
    const enroll = new Date(enrollDate);
    const cut3M = new Date(enroll); cut3M.setMonth(cut3M.getMonth() - 3);
    const cut5Y = new Date(enroll); cut5Y.setFullYear(cut5Y.getFullYear() - 5);
    if (d >= enroll) return 'post_enroll';
    if (d >= cut3M)  return 'within_3months';
    if (d >= cut5Y)  return 'within_5years';
    return 'before_5years';
  }

  function periodBadgeHtml(period) {
    const c = PERIOD_COLOR[period] || PERIOD_COLOR.unknown;
    return `<span class="vnx-period-badge" style="background:${c.secondary};color:${c.text};border:1px solid ${c.border};">${c.badge} ${c.label}</span>`;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì‚¬ì´ë“œë°” ë Œë”
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderSidebar(data) {
    const events = (data.events || []).sort((a, b) =>
      (a.date || '').localeCompare(b.date || '')
    );
    evCount.textContent = `(${events.length})`;

    if (events.length === 0) {
      eventList.innerHTML = '<div class="text-center text-muted p-3" style="font-size:.82rem;">ì´ë²¤íŠ¸ ì—†ìŒ</div>';
      return;
    }

    const enrollDate = data.enrollDate || data.patientInfo?.insuranceJoinDate || data.patientInfo?.enrollmentDate || null;
    eventList.innerHTML = events.map((ev, i) => {
      const hasSrc = !!ev.sourceRef;
      const period = getEventPeriod(ev, enrollDate);
      const c = PERIOD_COLOR[period] || PERIOD_COLOR.unknown;
      const borderColor = (period === 'within_3months' || period === 'within_5years') ? c.primary : 'transparent';
      return `<div class="ev-item ${hasSrc ? 'has-source' : ''}" data-idx="${i}" onclick="selectEvent(${i})"
        style="border-left: 3px solid ${borderColor};">
        <div style="display:flex;align-items:center;gap:4px;margin-bottom:2px;">
          ${periodBadgeHtml(period)}
          <span class="ev-date" style="color:${c.primary};">${ev.date || 'ë‚ ì§œ ì—†ìŒ'}</span>
        </div>
        <div class="ev-hospital">${ev.hospital || 'ë³‘ì› ë¯¸ìƒ'}</div>
        <div class="ev-type">${ev.eventType || ''}</div>
      </div>`;
    }).join('');
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // íƒ€ì„ë¼ì¸ ë Œë”
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTimeline(data) {
    const events = (data.events || []).sort((a, b) =>
      (a.date || '').localeCompare(b.date || '')
    );

    if (events.length === 0) {
      tlEvents.innerHTML = '<div class="text-center text-muted mt-4">ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    const enrollDate = data.enrollDate || data.patientInfo?.insuranceJoinDate || data.patientInfo?.enrollmentDate || null;
    tlEvents.innerHTML = events.map((ev, i) => {
      const hasSrc = !!ev.sourceRef;
      const period = getEventPeriod(ev, enrollDate);
      const c = PERIOD_COLOR[period] || PERIOD_COLOR.unknown;
      const cardBg = (period === 'within_3months') ? '#fff7f7'
                   : (period === 'within_5years')  ? '#fffbf5'
                   : '#ffffff';
      const leftBorder = (period === 'within_3months' || period === 'within_5years')
        ? `4px solid ${c.primary}` : '4px solid #dee2e6';
      return `<div class="tl-event ${hasSrc ? 'has-source' : ''}" id="tl-ev-${i}" onclick="selectEvent(${i})"
        style="background:${cardBg};border-left:${leftBorder};">
        <div class="d-flex align-items-center gap-2 mb-1 flex-wrap">
          ${periodBadgeHtml(period)}
          <span class="tl-date" style="color:${c.primary};">${ev.date || 'â€”'}</span>
          <span class="tl-type-badge">${ev.eventType || 'ê¸°íƒ€'}</span>
        </div>
        <div class="tl-hospital">${ev.hospital || 'ë³‘ì› ë¯¸ìƒ'}</div>
        ${ev.summary ? `<div class="tl-summary">${ev.summary}</div>` : ''}
        ${hasSrc ? `<button class="tl-source-btn" onclick="event.stopPropagation();jumpToSource(${i})">
          ğŸ“„ p.${ev.sourceRef.page}
        </button>` : ''}
      </div>`;
    }).join('');

    // í†µê³„ í‘œì‹œ
    if (data.statistics) {
      const s = data.statistics;
      tlEvents.insertAdjacentHTML('beforeend', `
        <div class="mt-3 p-2 bg-white border rounded" style="font-size:.78rem;color:#6c757d;">
          ì´ ì´ë²¤íŠ¸ ${s.totalEvents ?? '?'}ê°œ | ë‚ ì§œ ${s.datesFound ?? '?'}ê°œ | ë³‘ì› ${s.hospitalsFound ?? '?'}ê°œ
        </div>`);
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì´ë²¤íŠ¸ ì„ íƒ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function selectEvent(idx) {
    state.selectedEvent = idx;
    const events = (state.caseMeta?.events || []).sort((a, b) =>
      (a.date || '').localeCompare(b.date || '')
    );
    const ev = events[idx];
    if (!ev) return;

    // ì‚¬ì´ë“œë°” ê°•ì¡°
    document.querySelectorAll('.ev-item').forEach((el, i) =>
      el.classList.toggle('selected', i === idx)
    );
    // íƒ€ì„ë¼ì¸ ê°•ì¡°
    document.querySelectorAll('.tl-event').forEach((el, i) =>
      el.classList.toggle('selected', i === idx)
    );
    // íƒ€ì„ë¼ì¸ ìŠ¤í¬ë¡¤
    const tlEl = document.getElementById(`tl-ev-${idx}`);
    if (tlEl) tlEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    // sourceRef ìˆìœ¼ë©´ PDFë¡œ ì´ë™
    if (ev.sourceRef) jumpToSource(idx);
  }

  async function jumpToSource(idx) {
    const events = (state.caseMeta?.events || []).sort((a, b) =>
      (a.date || '').localeCompare(b.date || '')
    );
    const ev = events[idx];
    if (!ev || !ev.sourceRef) return;

    const sr = ev.sourceRef;
    const targetPage = sr.page || 1;
    const bbox = sr.bbox || null;

    // sourceFileì—ì„œ fileIndex ê²°ì •
    const pdfFiles = state.caseMeta?.pdfFiles || [];
    let fileIndex = state.pdfFileIndex;
    if (sr.sourceFile) {
      const fname = sr.sourceFile.split(/[\\/]/).pop();
      const found = pdfFiles.findIndex(f => f.filename === fname || fname.includes(f.filename));
      if (found >= 0) fileIndex = found;
    }

    if (fileIndex !== state.pdfFileIndex || !state.pdfDoc) {
      pdfFileSelector.value = fileIndex;
      await loadPdf(fileIndex, targetPage, bbox);
    } else {
      state.pendingHighlight = { page: targetPage, bbox };
      await gotoPage(targetPage);
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PDF íŒŒì¼ ì„ íƒê¸° ì„¤ì •
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setupPdfFileSelector(pdfFiles) {
    pdfFileSelector.innerHTML = pdfFiles.length === 0
      ? '<option value="">PDF ì—†ìŒ</option>'
      : pdfFiles.map((f, i) => `<option value="${i}">${f.filename}</option>`).join('');

    pdfFileSelector.onchange = () => loadPdf(parseInt(pdfFileSelector.value), 1, null);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PDF ë¡œë“œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadPdf(fileIndex, pageNum = 1, highlight = null) {
    if (!state.caseId) return;
    const pdfFiles = state.caseMeta?.pdfFiles || [];
    if (pdfFiles.length === 0) return;

    const idx = Math.min(Math.max(fileIndex, 0), pdfFiles.length - 1);
    state.pdfFileIndex = idx;
    pdfFileSelector.value = idx;

    pdfPlaceholder.style.display = 'none';
    pdfLoading.style.display = 'flex';
    pdfCanvasWrap.style.display = 'none';

    try {
      const url = `/api/pdf/${state.caseId}/file/${idx}`;
      const loadingTask = pdfjsLib.getDocument({ url, rangeChunkSize: 65536 });
      state.pdfDoc = await loadingTask.promise;
      state.totalPages = state.pdfDoc.numPages;
      state.pendingHighlight = highlight;

      await gotoPage(Math.min(Math.max(pageNum, 1), state.totalPages));
    } catch (e) {
      pdfLoading.style.display = 'none';
      pdfPlaceholder.style.display = 'flex';
      pdfPlaceholder.innerHTML = `<i class="bi bi-exclamation-triangle" style="font-size:2rem;color:#f90;"></i><span style="color:#f90;">PDF ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`;
      console.error('PDF load error:', e);
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // í˜ì´ì§€ ë Œë”
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function gotoPage(pageNum) {
    if (!state.pdfDoc) return;
    state.currentPage = Math.min(Math.max(pageNum, 1), state.totalPages);

    pdfLoading.style.display = 'flex';
    pdfCanvasWrap.style.display = 'none';

    const page = await state.pdfDoc.getPage(state.currentPage);
    const viewport = page.getViewport({ scale: state.zoom });

    // ë„ˆë¹„ ë§ì¶¤ (ì´ˆê¸°)
    if (state.zoom === 1.0) {
      const panelW = document.getElementById('pdf-scroll').clientWidth - 16;
      if (panelW > 0 && viewport.width > panelW) {
        state.zoom = panelW / viewport.width;
        return gotoPage(state.currentPage); // ì¬ê·€ í•œ ë²ˆ
      }
    }

    const vp = page.getViewport({ scale: state.zoom });
    pdfCanvas.width = vp.width;
    pdfCanvas.height = vp.height;
    pdfHighlight.width = vp.width;
    pdfHighlight.height = vp.height;

    await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport: vp }).promise;

    // í•˜ì´ë¼ì´íŠ¸
    const hl = state.pendingHighlight;
    if (hl && hl.page === state.currentPage && hl.bbox) {
      drawHighlight(pdfHighlight, hl.bbox, vp.width, vp.height);
    } else {
      clearHighlight(pdfHighlight);
    }

    pdfPageInfo.textContent = `${state.currentPage} / ${state.totalPages}`;
    btnPrev.disabled = state.currentPage <= 1;
    btnNext.disabled = state.currentPage >= state.totalPages;

    pdfLoading.style.display = 'none';
    pdfCanvasWrap.style.display = 'inline-block';
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // í•˜ì´ë¼ì´íŠ¸ ì˜¤ë²„ë ˆì´
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function drawHighlight(canvas, bbox, w, h) {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, w, h);

    // bboxê°€ 0~1 ì •ê·œí™”ëœ ê°’ì¸ì§€, í”½ì…€ ì ˆëŒ€ê°’ì¸ì§€ íŒë³„
    const isNorm = bbox.xMax <= 1 && bbox.yMax <= 1;
    const x  = isNorm ? bbox.xMin * w : bbox.xMin;
    const y  = isNorm ? bbox.yMin * h : bbox.yMin;
    const bw = isNorm ? (bbox.xMax - bbox.xMin) * w : (bbox.xMax - bbox.xMin);
    const bh = isNorm ? (bbox.yMax - bbox.yMin) * h : (bbox.yMax - bbox.yMin);

    ctx.fillStyle = 'rgba(255, 220, 0, 0.25)';
    ctx.fillRect(x, y, bw, bh);
    ctx.strokeStyle = 'rgba(255, 140, 0, 0.85)';
    ctx.lineWidth = 2;
    ctx.strokeRect(x, y, bw, bh);
  }

  function clearHighlight(canvas) {
    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // íˆ´ë°” ë²„íŠ¼
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  btnPrev.addEventListener('click', () => {
    if (state.currentPage > 1) gotoPage(state.currentPage - 1);
  });
  btnNext.addEventListener('click', () => {
    if (state.currentPage < state.totalPages) gotoPage(state.currentPage + 1);
  });
  btnZoomIn.addEventListener('click', () => { state.zoom = Math.min(state.zoom * 1.2, 4); gotoPage(state.currentPage); });
  btnZoomOut.addEventListener('click', () => { state.zoom = Math.max(state.zoom / 1.2, 0.3); gotoPage(state.currentPage); });
  btnZoomFit.addEventListener('click', () => {
    const panelW = document.getElementById('pdf-scroll').clientWidth - 16;
    if (state.pdfDoc && panelW > 0) {
      state.pdfDoc.getPage(state.currentPage).then(page => {
        const vp = page.getViewport({ scale: 1 });
        state.zoom = panelW / vp.width;
        gotoPage(state.currentPage);
      });
    }
  });

  // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
  document.addEventListener('keydown', e => {
    if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') return;
    if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') btnPrev.click();
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') btnNext.click();
    if (e.key === '+' || e.key === '=') btnZoomIn.click();
    if (e.key === '-') btnZoomOut.click();
    if (e.key === '0') btnZoomFit.click();
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì¼€ì´ìŠ¤ ì„ íƒê¸°
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  caseSelector.addEventListener('change', () => {
    const val = caseSelector.value;
    if (!val) return;
    state.zoom = 1.0;
    state.pdfDoc = null;
    const url = new URL(window.location);
    url.searchParams.set('case', val);
    url.searchParams.delete('page');
    url.searchParams.delete('bbox');
    window.history.replaceState({}, '', url);
    loadCase(val);
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì•± ì‹œì‘
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  initCaseList();
</script>

</body>
</html>

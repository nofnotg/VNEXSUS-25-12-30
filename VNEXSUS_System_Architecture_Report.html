<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNEXSUS System Architecture & Pipeline Report</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f9f9f9;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        h1 {
            margin: 0;
            font-size: 24px;
        }

        h2 {
            color: #2980b9;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 40px;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .diagram-container {
            background: #fff;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .status-complete {
            background: #27ae60;
        }

        .status-progress {
            background: #f39c12;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }

        li:before {
            content: "✓";
            color: #27ae60;
            position: absolute;
            left: 0;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <header>
        <h1>VNEXSUS System Architecture & Pipeline Report</h1>
        <p>Current State, Data Flow, and Logic Visualization</p>
    </header>

    <div class="section">
        <h2>1. Executive Summary</h2>
        <p>
            현재 VNEXSUS 시스템은 <strong>"Hybrid Architecture (Rule-based + LLM)"</strong>로 전환을 완료하였으며,
            데이터의 무결성을 보장하기 위해 <strong>"Superset-Subset Architecture"</strong>를 도입했습니다.
            이 보고서는 개선된 파이프라인의 전체 데이터 흐름과 각 모듈의 역할을 시각적으로 설명합니다.
        </p>
        <div style="margin-top: 20px;">
            <span class="status-badge status-complete">Phase 1: Fact Extraction (HybridNER)</span>
            <span class="status-badge status-complete">Phase 2: 3D Vector Evaluation</span>
            <span class="status-badge status-complete">Phase 3: Writer Agent (Real LLM)</span>
            <span class="status-badge status-complete">Phase 4: Superset-Subset Verification</span>
        </div>
    </div>

    <div class="section">
        <h2>2. High-Level System Architecture</h2>
        <p>전체 시스템은 크게 <strong>Extraction (추출)</strong>, <strong>Evaluation (평가)</strong>, <strong>Generation
                (생성)</strong>의 3단계로 구성됩니다.</p>
        <div class="diagram-container">
            <div class="mermaid">
                graph TD
                subgraph "Input Layer"
                Raw["Raw OCR Text (CaseX.txt)"]
                Contract["Contract Info (2024-01-01)"]
                end

                subgraph "Phase 1: Core Engine (Fact Extraction)"
                Raw --> Preprocess["Preprocessing & Template Matching"]
                Preprocess --> Regex["Strict Regex Extraction (Dates, ICD)"]
                Regex --> Superset["Superset Event List (All Events)"]
                end

                subgraph "Phase 2: 3D Vector Evaluation"
                Superset --> VectorSvc["VectorEvaluationService"]
                VectorSvc --> X["X: Severity (Medical)"]
                VectorSvc --> Y["Y: Temporal (Contract Date)"]
                VectorSvc --> Z["Z: Certainty (Evidence)"]
                X & Y & Z --> VectorResult["3D Vector Result"]
                end

                subgraph "Phase 3: Writer Agent (Generation)"
                Superset --> Writer["WriterAgentService"]
                VectorResult --> Writer
                Writer --> LLM["OpenAI GPT-4o"]
                LLM --> Report["Final Narrative Report"]
                end

                subgraph "Phase 4: Verification"
                Report --> Verify["Inclusion Verification"]
                Superset --> Verify
                Verify --> Score["Inclusion Score (100% Target)"]
                end

                style Superset fill:#e1f5fe,stroke:#01579b,stroke-width:2px
                style Report fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
                style Score fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
            </div>
        </div>
    </div>

    <div class="section">
        <h2>3. Detailed Data Flow: Superset-Subset Architecture</h2>
        <p>
            데이터 환각(Hallucination)을 방지하고 정확성을 보장하기 위해,
            <strong>앱이 추출한 전체 데이터(Superset)</strong> 내에서만
            <strong>보고서 내용(Subset)</strong>을 생성하도록 강제하는 아키텍처입니다.
        </p>
        <div class="diagram-container">
            <div class="mermaid">
                sequenceDiagram
                participant Raw as Raw Text
                participant Core as CoreEngine
                participant Vector as VectorModel
                participant Writer as WriterAgent
                participant LLM as OpenAI
                participant Report as Final Report

                Raw->>Core: 1. Input Text
                Core->>Core: 2. Extract ALL Events (Superset)
                Note right of Core: Contains 100% of Dates/Facts

                Core->>Vector: 3. Send Superset
                Vector->>Vector: 4. Calculate Risk (X, Y, Z)
                Vector-->>Core: 5. Return Vector Result

                Core->>Writer: 6. Superset + Vector Result
                Writer->>LLM: 7. Prompt with Strict Constraints
                Note right of Writer: "Use ONLY events from Superset"

                LLM-->>Writer: 8. Generated Narrative
                Writer-->>Report: 9. Final Report (Subset)

                Note over Core, Report: Verification: Report ⊆ Superset (100% Inclusion)
            </div>
        </div>
    </div>

    <div class="section">
        <h2>4. Key Modules & Logic</h2>

        <h3>4.1 CoreEngineService (The Extractor)</h3>
        <ul>
            <li><strong>역할:</strong> 원본 텍스트에서 의료 이벤트(날짜, 진단, 치료)를 빠짐없이 추출합니다.</li>
            <li><strong>개선사항:</strong> 정규식(Regex)을 강화하여 `YYYY-MM-DD`, `YYYY.MM.DD` 등 다양한 날짜 포맷을 모두 포착하여
                <strong>Superset</strong>을 구축합니다.</li>
        </ul>

        <h3>4.2 VectorEvaluationService (The Judge)</h3>
        <ul>
            <li><strong>역할:</strong> 추출된 이벤트를 3차원 공간에 매핑하여 리스크를 평가합니다.</li>
            <li><strong>X축 (임상적 중증도):</strong> 뇌질환, 암 등 중대 질환 여부 (0~10)</li>
            <li><strong>Y축 (시계열적 연관성):</strong> 계약일(`2024-01-01`) 기준 근접성 (0~10)</li>
            <li><strong>Z축 (의료적 확실성):</strong> 확진, 입원 등 명확한 근거 여부 (0~10)</li>
        </ul>

        <h3>4.3 WriterAgentService (The Narrator)</h3>
        <ul>
            <li><strong>역할:</strong> 평가 결과와 Superset을 바탕으로 사람이 읽기 쉬운 보고서를 작성합니다.</li>
            <li><strong>제약조건:</strong> <strong>"Superset-Subset Principle"</strong>을 프롬프트에 명시하여, 제공된 이벤트 리스트 외의 정보를 생성하지
                못하도록 차단합니다.</li>
        </ul>
    </div>

    <div class="section">
        <h2>5. Verification Process</h2>
        <p>검증 스크립트(<code>verify_full_pipeline.js</code>)는 다음 로직으로 시스템을 검증합니다.</p>
        <div class="diagram-container">
            <div class="mermaid">
                flowchart LR
                A["Generated Report"] --> B{"Extract Dates"}
                C["Superset Events"] --> D{"Extract Dates"}
                B --> E["Comparison"]
                D --> E
                E --> F{"Is Report ⊆ Superset?"}
                F -- Yes --> G["PASS (Inclusion 100%)"]
                F -- No --> H["FAIL (Hallucination Detected)"]
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</body>

</html>
import fs from 'fs';
import path from 'path';
import { getSchemaForPrompt } from '../services/structuredReportSchema.js';
// __filename/__dirname ê³„ì‚°ì€ ë¶ˆí•„ìš”í•˜ë¯€ë¡œ ì œê±°í•˜ì—¬ Jest í™˜ê²½ í˜¸í™˜ì„± í™•ë³´

// ğŸ§¬ ë‹¤ë‹¨ê³„ DNA ì‹œí€€ì‹± íŒŒì´í”„ë¼ì¸
export class EnhancedMedicalDnaAnalyzer {
    constructor() {
        this.stages = {
            stage1: 'RAW_DATA_SEGMENTATION',
            stage2: 'TEMPORAL_EXTRACTION',
            stage3: 'ENTITY_RECOGNITION',
            stage4: 'STATISTICAL_AGGREGATION',
            stage5: 'FINAL_SYNTHESIS'
        };
    }

    // ğŸ” 1ë‹¨ê³„: ì›ì‹œ ë°ì´í„° ì„¸ê·¸ë©˜í…Œì´ì…˜
    async segmentRawData(extractedText) {
        const segments = {
            timelineData: this.extractTimelineSegments(extractedText),
            insuranceData: this.extractInsuranceSegments(extractedText),
            hospitalData: this.extractHospitalSegments(extractedText),
            patientData: this.extractPatientSegments(extractedText)
        };

        return segments;
    }

    // ğŸ“… 2ë‹¨ê³„: ì‹œê°„ì¶• ë°ì´í„° ì „ë¬¸ ì¶”ì¶œ
    async extractTemporalData(segments) {
        const prompt = `
# ğŸ• ì‹œê°„ì¶• ë°ì´í„° ì „ë¬¸ ì¶”ì¶œê¸° (2000-2025 ì „ì²´ ìŠ¤ìº”)

ë‹¹ì‹ ì€ ì˜ë£Œê¸°ë¡ì—ì„œ **ëª¨ë“  ì‹œê°„ ì •ë³´ë¥¼ ì •í™•íˆ ì¶”ì¶œ**í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

## ğŸ¯ ì¶”ì¶œ ëª©í‘œ
1. **ì „ì²´ ì—°ë„ ìŠ¤ìº”**: 2000, 2001, 2002... 2025ë…„ ëª¨ë“  ë‚ ì§œ
2. **ë³‘ì›ë³„ í†µì› íŒ¨í„´**: ì²« ë°©ë¬¸~ë§ˆì§€ë§‰ ë°©ë¬¸, ì´ íšŸìˆ˜
3. **ë³´í—˜ ê°€ì… ì‹œì **: ëª¨ë“  ë³´í—˜ì‚¬ì˜ ê°€ì…ì¼ ì¶”ì 

## ğŸ“Š ì¶œë ¥ í˜•ì‹ (JSON)
\`\`\`json
{
  "timelineEvents": [
    {
      "date": "2019-11-15",
      "hospital": "ë‚´ë‹¹ìµœë‚´ê³¼ì˜ì›",
      "eventType": "ì²«ë°©ë¬¸",
      "diagnosis": "ê¸°íƒ€ ë‹¤ë°œì„± í•©ë³‘ì¦ì„ ë™ë°˜í•œ 2í˜• ë‹¹ë‡¨ë³‘(E11.78)"
    }
  ],
  "hospitalStatistics": [
    {
      "hospital": "ë‚´ë‹¹ìµœë‚´ê³¼ì˜ì›",
      "firstVisit": "2019-11-15",
      "lastVisit": "2024-08-14",
      "totalVisits": 23,
      "period": "4ë…„ 9ê°œì›”"
    }
  ],
  "insuranceTimeline": [
    {
      "company": "AXAì†í•´ë³´í—˜",
      "joinDate": "2019-09-27",
      "product": "ë¬´ë°°ë‹¹ AXA ë‚˜ë¥¼ì§€ì¼œì£¼ëŠ”ê±´ê°•ë³´í—˜",
      "type": "5ë…„ ì´ë‚´"
    }
  ]
}
\`\`\`

**ë¶„ì„ ëŒ€ìƒ:**
${segments.timelineData}

ì§€ê¸ˆ ì¦‰ì‹œ ëª¨ë“  ì‹œê°„ ì •ë³´ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œí•˜ì„¸ìš”!
        `;

        return prompt;
    }

    // ğŸ¥ 3ë‹¨ê³„: ì—”í‹°í‹° ì¸ì‹ ë° ì •ê·œí™”
    async recognizeEntities(segments) {
        const prompt = `
# ğŸ¥ ì˜ë£Œ ì—”í‹°í‹° ì¸ì‹ ë° ì •ê·œí™” ì „ë¬¸ê°€

## ğŸ¯ ì¸ì‹ ëŒ€ìƒ
1. **ë³‘ì›ëª… ì •ê·œí™”**: "ê°•ë‚¨ì„±ì‹¬ë³‘ì›" = "í•œë¦¼ëŒ€í•™êµ ê°•ë‚¨ì„±ì‹¬ë³‘ì›"
2. **ë³´í—˜ì‚¬ëª… ì •í™• ì¶”ì¶œ**: AXA, ì‚¼ì„±í™”ì¬, í¥êµ­í™”ì¬ ë“±
3. **ì§„ë‹¨ëª… í‘œì¤€í™”**: ICD ì½”ë“œ í¬í•¨

## ğŸ“‹ ì •ê·œí™” ê·œì¹™
- ë³‘ì›ëª…: ê³µì‹ëª…ì¹­ìœ¼ë¡œ í†µì¼
- ë³´í—˜ì‚¬: ì •í™•í•œ íšŒì‚¬ëª… ì‚¬ìš©
- ì§„ë‹¨ëª… í‘œì¤€í™”: [ICDì½”ë“œ/ì˜ë¬¸ëª…-í•œê¸€ëª…] í˜•ì‹

**ë¶„ì„ ëŒ€ìƒ:**
${segments.hospitalData}
${segments.insuranceData}

ì •ê·œí™”ëœ ì—”í‹°í‹° ëª©ë¡ì„ ìƒì„±í•˜ì„¸ìš”!
        `;

        return prompt;
    }

    // ğŸ“Š 4ë‹¨ê³„: í†µê³„ì  ì§‘ê³„
    async aggregateStatistics(extractedData) {
        const prompt = `
# ğŸ“Š ì˜ë£Œ í†µê³„ ì§‘ê³„ ì „ë¬¸ê°€

## ğŸ¯ ì§‘ê³„ í•­ëª©
1. **ë³‘ì›ë³„ í†µì› í†µê³„**: "ë³‘ì›ëª… YYYY.MM.DD ~ YYYY.MM.DD / XíšŒ í†µì›"
2. **ì§„ë‹¨ë³„ ë¹ˆë„**: ì£¼ìš” ì§„ë‹¨ëª…ë³„ ë°œìƒ íšŸìˆ˜
3. **ë³´í—˜ë³„ ì²­êµ¬ ë‚´ì—­**: ë³´í—˜ì‚¬ë³„ ì²­êµ¬ ê¸ˆì•¡ ë° íšŸìˆ˜

## ğŸ“ˆ í•„ìˆ˜ ê³„ì‚°
- ì´ í†µì› íšŸìˆ˜
- í†µì› ê¸°ê°„ (ë…„/ì›” ë‹¨ìœ„)
- ì£¼ìš” ì§„ë‹¨ëª… ë¹ˆë„
- ë³´í—˜ ê°€ì… ì „í›„ ë¶„ë¥˜

**ì§‘ê³„ ëŒ€ìƒ ë°ì´í„°:**
${extractedData}

í†µê³„ ì§‘ê³„ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì„¸ìš”!
        `;

        return prompt;
    }

    // ğŸ¯ 5ë‹¨ê³„: ìµœì¢… ì†í•´ì‚¬ì • ë³´ê³ ì„œ í•©ì„±
    async synthesizeFinalReport(allData, insuranceJoinDate = null) {
        const prompt = this.buildFinalSynthesisPrompt(allData, insuranceJoinDate);
        return prompt;
    }

    buildFinalSynthesisPrompt(allData, insuranceJoinDate) {
        const periodInfo = this.calculateInsurancePeriods(insuranceJoinDate);

        return `
# ğŸ† ì†í•´ì‚¬ì • ë³´ê³ ì„œ ìµœì¢… í•©ì„± ì „ë¬¸ê°€ (Expert Level)

ë‹¹ì‹ ì€ **ëª¨ë“  ë‹¨ê³„ì˜ ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©**í•˜ì—¬, ë³´í—˜ì‚¬ ì‹¬ì‚¬ìê°€ ê²°ì¬í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ì˜ **ì „ë¬¸ ì†í•´ì‚¬ì • ë³´ê³ ì„œ**ë¥¼ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

## ğŸ¯ ì‘ì„± ëª©í‘œ
1. **ê²°ì¬ìš© ìš”ì•½ë³¸(í•µì‹¬ë³´ê³ ì„œ)ì„ ìµœìƒë‹¨ì— ë°°ì¹˜**í•˜ì—¬ ì‹¬ì‚¬ìê°€ ì¦‰ì‹œ íŒŒì•…í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
2. **ê³ ì§€ì˜ë¬´ ìœ„ë°˜ ì—¬ë¶€**ë¥¼ ì •ë°€í•˜ê²Œ ë¶„ì„í•˜ì—¬ ì‹œê°ì ìœ¼ë¡œ ê°•ì¡°í•©ë‹ˆë‹¤.
3. **ì§ˆí™˜ë³„ í•„ìˆ˜ ê²€ì‚¬ê²°ê³¼**ë¥¼ ëˆ„ë½ ì—†ì´ í¬í•¨í•©ë‹ˆë‹¤.

${periodInfo ? `
## ğŸ“… ê³ ì§€ì˜ë¬´ ë¶„ì„ ê¸°ì¤€ (ë³´í—˜ ê°€ì…ì¼: ${periodInfo.joinDate})
- **[3ê°œì›” ì´ë‚´]**: ${periodInfo.threeMonthsBefore} ~ ${periodInfo.joinDate}
  - ëŒ€ìƒ: ì§ˆë³‘ í™•ì •ì§„ë‹¨, ì˜ì‹¬ì†Œê²¬, ì…ì›/ìˆ˜ìˆ /ì¶”ê°€ê²€ì‚¬ í•„ìš” ì†Œê²¬
- **[1ë…„ ì´ë‚´]**: ${periodInfo.oneYearBefore} ~ ${periodInfo.joinDate}
  - ëŒ€ìƒ: ì§„ì°°/ê²€ì‚¬ (ì¼ë¶€ ìƒí’ˆ ê¸°ì¤€)
- **[5ë…„ ì´ë‚´]**: ${periodInfo.fiveYearsBefore} ~ ${periodInfo.joinDate}
  - ëŒ€ìƒ: ì•”, ë°±í˜ˆë³‘, ê³ í˜ˆì••, í˜‘ì‹¬ì¦, ì‹¬ê·¼ê²½ìƒ‰, ì‹¬ì¥íŒë§‰ì¦, ê°„ê²½í™”, ë‡Œì¡¸ì¤‘, ë‹¹ë‡¨ë³‘, ì—ì´ì¦ˆì˜ ì§„ë‹¨/ì…ì›/ìˆ˜ìˆ 
` : `
## ğŸ“… ê³ ì§€ì˜ë¬´ ë¶„ì„ ê¸°ì¤€
- ë¬¸ì„œ ë‚´ **ë³´í—˜ ê°€ì…ì¼**ì„ ì°¾ì•„ 3ê°œì›”/1ë…„/5ë…„ êµ¬ê°„ì„ ìë™ ê³„ì‚°í•˜ì—¬ ì ìš©í•˜ì„¸ìš”.
`}

## ğŸ¥ ì§ˆí™˜ë³„ ê²€ì‚¬ê²°ê³¼ ë°˜ì˜ ê·œì¹™ (í•„ìˆ˜ ì ìš©)
1. **í˜‘ì‹¬ì¦**: Chest CT, Cardiac MRI, Coronary CT-Angio (í˜‘ì°©ë¥ , TIMI flow)
2. **ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰**: Troponin, CK-MB, EKG(ST elevation), PCI/Stent ê¸°ë¡
3. **ë¶€ì •ë§¥**: EKG(ë¦¬ë“¬), 24h Holter(ë¹ˆë„, HR)
4. **ë‡Œí˜ˆê´€ì§ˆí™˜**: Brain CT/MRI/MRA/Angio (íìƒ‰/ì¶œí˜ˆ ë¶€ìœ„ ë° ë²”ìœ„)
5. **ì•”(Cancer)**:
   - **ì¡°ì§ê²€ì‚¬ ê²°ê³¼ í•„ìˆ˜**: ê²€ì‚¬ëª… / ì‹œí–‰ì¼ / ë³´ê³ ì¼ / ì§„ë‹¨ëª…(ì˜ë¬¸+í•œê¸€) / ì†Œê²¬ / ë³‘ê¸°(TNM)
   - **ì›ë°œ/ì „ì´ êµ¬ë¶„**: "ë¶„ë¥˜: [ì›ë°œë¶€ìœ„] ì›ë°œ + [ì „ì´ë¶€ìœ„] ì „ì´" í˜•ì‹ ì¤€ìˆ˜

## ğŸ“Š ë¶„ì„ ì™„ë£Œëœ ë°ì´í„°
**ì‹œê°„ì¶• ë°ì´í„°**: ${allData.timelineData || 'ì¶”ì¶œ í•„ìš”'}
**ë³‘ì› í†µê³„**: ${allData.hospitalStats || 'ì§‘ê³„ í•„ìš”'}  
**ë³´í—˜ ì •ë³´**: ${allData.insuranceInfo || 'ì •ë¦¬ í•„ìš”'}
**ì§„ë‹¨ íŒ¨í„´**: ${allData.diagnosisPatterns || 'ë¶„ì„ í•„ìš”'}

## ğŸ“ ì¶œë ¥ í˜•ì‹ (JSON Block + Markdown)

**ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ì„ ì •í™•íˆ ì§€ì¼œì„œ ì¶œë ¥í•˜ì„¸ìš”.**

\`\`\`json
{
  "violationAlert": {
    "detected": true/false,
    "title": "ê³ ì§€ì˜ë¬´ ìœ„ë°˜ ì˜ì‹¬" ë˜ëŠ” "ê³ ì§€ì˜ë¬´ ìœ„ë°˜ ì‚¬í•­ ì—†ìŒ",
    "summary": "í™˜ìëŠ” ê³„ì•½ ì „ 12ì¼ì— ë‡Œí˜ˆê´€ì§ˆí™˜(I67.8)ìœ¼ë¡œ ì§„ë‹¨ë°›ì•˜ìŠµë‹ˆë‹¤. ì´ëŠ” 3ê°œì›” ì´ë‚´ ê³ ì§€ì˜ë¬´ ìœ„ë°˜ì— í•´ë‹¹í•©ë‹ˆë‹¤.",
    "criticalEvents": [
      {
        "date": "2025-02-17",
        "dDay": "D-12",
        "content": "ê°•ë‚¨ì„±ì‹¬ë³‘ì› | ì§„ë‹¨: ë‡Œí˜ˆê´€ì§ˆí™˜(I67.8)",
        "isCritical": true
      },
      {
        "date": "2025-03-01",
        "dDay": "Contract Date",
        "content": "ë³´í—˜ ê°€ì…ì¼ (Health Premium Plus)",
        "isCritical": false
      }
    ]
  }
}
\`\`\`

---

# ğŸ“‘ ì†í•´ì‚¬ì • ë³´ê³ ì„œ (ê²°ì¬ìš© ìš”ì•½ë³¸)

**âš ï¸ ì¤‘ìš”: ì•„ë˜ 10ê°œ í•­ëª© ì™¸ì˜ í•­ëª©(ì§„ë£Œì˜ì‚¬, ë³´í—˜ìœ í˜• ë“±)ì€ ì ˆëŒ€ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”.**

1. **ë‚´ì›ì¼ì‹œ**: yyyy.mm.dd
2. **ë‚´ì›ê²½ìœ„(ì£¼í˜¸ì†Œ)**: (ì™¸ë¶€ ë³‘ì› ì§„ë£Œì˜ë¢°, ì¦ìƒ ìš”ì•½)
3. **ì§„ë‹¨ë³‘ëª…**: (ë°˜ë“œì‹œ [KCD-10ì½”ë“œ] [ì˜ë¬¸ëª…] [í•œê¸€ëª…] í˜•ì‹ìœ¼ë¡œ í‘œê¸°, ì˜ˆ: [C16.0] Malignant neoplasm of cardia - ìœ„ì•”)
4. **ê²€ì‚¬ê²°ê³¼**: (ê²€ì‚¬ëª…, ê²€ì‚¬ì¼, ê²€ì‚¬ê²°ê³¼, ì†Œê²¬ / ì˜ë¬¸+í•œê¸€ ë²ˆì—­)
5. **ìˆ˜ìˆ  í›„ ì¡°ì§ê²€ì‚¬ ê²°ê³¼(ì•”ì˜ ê²½ìš°ë§Œ)**: (ê²€ì‚¬ëª…, ê²€ì‚¬ì¼, ë³´ê³ ì¼, ì¡°ì§ê²€ì‚¬ ì†Œê²¬, ë³‘ê¸° TNM)
6. **ì¹˜ë£Œë‚´ìš©**: (ìˆ˜ìˆ /ì•½ë¬¼/ë°©ì‚¬ì„ /ì²˜ì¹˜ ë“±)
7. **í†µì›ê¸°ê°„**: yyyy.mm.dd ~ yyyy.mm.dd / níšŒ í†µì›
8. **ì…ì›ê¸°ê°„**: yyyy.mm.dd ~ yyyy.mm.dd / nì¼ ì…ì›
9. **ê³¼ê±°ë³‘ë ¥**: (ì£¼ìš” ì§ˆí™˜, í•©ë³‘ì¦ ë“±)
10. **ì˜ì‚¬ì†Œê²¬**: (ì£¼ì¹˜ì˜ ê¸°ì¬ ë‚´ìš© ìš”ì•½)

- **ê³ ì§€ì˜ë¬´ ìœ„ë°˜ ì—¬ë¶€**: **[ìœ„ë°˜ ìˆìŒ/ì—†ìŒ]** (ê·¼ê±°: ...)
- **ì¢…í•©ì˜ê²¬**: (í•œ ì¤„ ìš”ì•½)

---

# ğŸ“‹ ìƒì„¸ ì†í•´ì‚¬ì • ë³´ê³ ì„œ (í™•ì¥í˜•)

## 1. í™˜ì ë° ê³„ì•½ ì •ë³´
- **í”¼ë³´í—˜ì**: [ì´ë¦„] ([ìƒë…„ì›”ì¼])
- **ë³´í—˜ìƒí’ˆ**: [ìƒí’ˆëª…] (ê°€ì…ì¼: [YYYY-MM-DD])
- **ê³ ì§€ ê¸°ì¤€**: 3ê°œì›” / 1ë…„ / 5ë…„

## 2. ê³ ì§€ì˜ë¬´ ë¶„ì„ ê²°ê³¼
### [5ë…„ ì´ë‚´] (${periodInfo ? periodInfo.fiveYearsBefore : '...'} ~ )
- (í•´ë‹¹ ì‚¬í•­ ì—†ìœ¼ë©´ "íŠ¹ì´ì‚¬í•­ ì—†ìŒ")
- [YYYY-MM-DD] [ë³‘ì›ëª…] [ì§„ë‹¨ëª…] (ë‚´ìš©)

### [1ë…„ ì´ë‚´] (${periodInfo ? periodInfo.oneYearBefore : '...'} ~ )
- ...

### [3ê°œì›” ì´ë‚´] (${periodInfo ? periodInfo.threeMonthsBefore : '...'} ~ )
- ...

## 3. ìƒì„¸ ì˜ë£Œ ë¶„ì„
(ì‹œê°„ìˆœìœ¼ë¡œ ìƒì„¸ ë‚´ì—­ ê¸°ìˆ , ì§ˆí™˜ë³„ ê²€ì‚¬ê²°ê³¼ ê·œì¹™ ì¤€ìˆ˜)

**âš ï¸ ë‚ ì§œë³„ í•­ëª© ë°°ì¹˜ ìˆœì„œ (í•„ìˆ˜):**
1. ë‚ ì§œ (í—¤ë”)
2. ì§„ë‹¨ (ìµœìƒë‹¨) - [KCDì½”ë“œ/ì˜ë¬¸ëª…-í•œê¸€ëª…]
3. ê²€ì‚¬ê²°ê³¼/ì¹˜ë£Œë‚´ìš© (ì¤‘ê°„)
4. ë‚´ì›ê²½ìœ„ ì½”ë©˜íŠ¸ (í•˜ë‹¨)
5. ë³‘ì›ëª… (ìµœí•˜ë‹¨)

**í˜•ì‹ ì˜ˆì‹œ:**
**[YYYY-MM-DD]**
ì§„ë‹¨: [I10/Essential Hypertension-ë³¸íƒœì„± ê³ í˜ˆì••]
ê²€ì‚¬: í˜ˆì•• ì¸¡ì • 150/95 mmHg
ì¹˜ë£Œ: ì•½ë¬¼ ì¹˜ë£Œ ì‹œì‘
í™˜ìëŠ” ê³ í˜ˆì••ìœ¼ë¡œ ë‚´ì›í•˜ì˜€ìœ¼ë©°...
ë³‘ì›ëª…: [ì„œìš¸ë‚´ê³¼ì˜ì›]

**âš ï¸ ê¸ˆì§€: "ì§„ë£Œì¼: [YYYY-MM-DD]" ë³„ë„ í‘œê¸° (ë‚ ì§œ í—¤ë”ì—ì„œ ì´ë¯¸ í‘œê¸°ë¨)**

## 4. ì¢…í•© ì†Œê²¬
(ì†í•´ì‚¬ì •ì‚¬ì˜ ì „ë¬¸ì  ê²¬í•´)

---
**ë¶„ì„ ëŒ€ìƒ ì›ë³¸ ë°ì´í„°:**
${allData.originalText || ''}
        `;
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    extractTimelineSegments(text) {
        // ë‚ ì§œê°€ í¬í•¨ëœ ì„¹ì…˜ë“¤ ì¶”ì¶œ
        const lines = text.split('\n');
        const timelineLines = lines.filter(line =>
            /\d{4}[.-]\d{2}[.-]\d{2}/.test(line) ||
            /\d{4}\.\d{2}\.\d{2}/.test(line) ||
            line.includes('ë‚´ì›ì¼') ||
            line.includes('ê°€ì…ì¼')
        );
        return timelineLines.join('\n');
    }

    extractInsuranceSegments(text) {
        const insuranceKeywords = ['AXA', 'ì‚¼ì„±í™”ì¬', 'í¥êµ­í™”ì¬', 'MGì†í•´ë³´í—˜', 'í˜„ëŒ€í•´ìƒ', 'ê°€ì…ì¼', 'ë³´í—˜'];
        const lines = text.split('\n');
        const insuranceLines = lines.filter(line =>
            insuranceKeywords.some(keyword => line.includes(keyword))
        );
        return insuranceLines.join('\n');
    }

    extractHospitalSegments(text) {
        const lines = text.split('\n');
        const hospitalLines = lines.filter(line =>
            /[ê°€-í£]+(?:ë³‘ì›|ì˜ì›|í´ë¦¬ë‹‰|ì„¼í„°)/.test(line) ||
            line.includes('ë‚´ì›') ||
            line.includes('í†µì›') ||
            line.includes('ì§„ë£Œ')
        );
        return hospitalLines.join('\n');
    }

    extractPatientSegments(text) {
        const lines = text.split('\n');
        const patientLines = lines.filter(line =>
            line.includes('í™˜ìëª…') ||
            line.includes('ì„±ëª…') ||
            line.includes('ìƒë…„ì›”ì¼') ||
            /\d{6}-[12]/.test(line)
        );
        return patientLines.join('\n');
    }

    calculateInsurancePeriods(insuranceDate) {
        if (!insuranceDate) return null;

        const joinDate = new Date(insuranceDate);
        const threeMonthsAgo = new Date(joinDate);
        threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
        const oneYearAgo = new Date(joinDate);
        oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
        const fiveYearsAgo = new Date(joinDate);
        fiveYearsAgo.setFullYear(fiveYearsAgo.getFullYear() - 5);

        return {
            joinDate: joinDate.toISOString().split('T')[0],
            threeMonthsBefore: threeMonthsAgo.toISOString().split('T')[0],
            oneYearBefore: oneYearAgo.toISOString().split('T')[0],
            fiveYearsBefore: fiveYearsAgo.toISOString().split('T')[0]
        };
    }
}

// ê°œì„ ëœ ë‹¨ì¼ í”„ë¡¬í”„íŠ¸ (ê¸°ì¡´ ì‹œìŠ¤í…œê³¼ í˜¸í™˜)
export function buildEnhancedMedicalDnaPrompt(extractedText, knowledgeBase, insuranceJoinDate = null) {
    const analyzer = new EnhancedMedicalDnaAnalyzer();
    const { abbreviations } = knowledgeBase;

    // ë³´í—˜ ê°€ì…ì¼ ê¸°ì¤€ ê¸°ê°„ ê³„ì‚°
    const periodInfo = analyzer.calculateInsurancePeriods(insuranceJoinDate);
    const insurancePeriodGuide = periodInfo ? `
## ğŸ“… ë³´í—˜ ê°€ì…ì¼ ê¸°ì¤€ ì •í™•í•œ ê¸°ê°„ ë¶„ë¥˜
**ì œê³µëœ ë³´í—˜ ê°€ì…ì¼**: ${periodInfo.joinDate}
- **[3ê°œì›” ì´ë‚´]**: ${periodInfo.threeMonthsBefore} ~ ${periodInfo.joinDate} (ê³ ì§€ì˜ë¬´ìœ„ë°˜ ì£¼ì˜)
- **[1ë…„ ì´ë‚´]**: ${periodInfo.oneYearBefore} ~ ${periodInfo.joinDate}
- **[5ë…„ ì´ë‚´]**: ${periodInfo.fiveYearsBefore} ~ ${periodInfo.joinDate}  
- **[ì²­êµ¬ì‚¬í•­]**: ${periodInfo.joinDate} ì´í›„

**ì¤‘ìš”**: ìœ„ ê¸°ì¤€ìœ¼ë¡œ ëª¨ë“  ì˜ë£Œ ì´ë²¤íŠ¸ë¥¼ ì •í™•íˆ ë¶„ë¥˜í•˜ì„¸ìš”!
` : `
## ğŸ“… ë¬¸ì„œ ë‚´ ë³´í—˜ ê°€ì…ì¼ ì°¾ê¸°
ë¬¸ì„œì—ì„œ "ê°€ì…ì¼", "ë³´ì¥ê°œì‹œì¼", "ê³„ì•½ì¼"ì„ ì°¾ì•„ ì •í™•í•œ ê¸°ê°„ ë¶„ë¥˜ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”.
`;

    const systemPrompt = `
# ğŸ§¬ VNEXSUS DNA ì‹œí€€ì‹± v2.0 - ë³´í—˜ ì²­êµ¬ ë¬¸ì„œ ë¶„ì„ ì „ë¬¸ AI

ë‹¹ì‹ ì€ **ë³´í—˜ ì²­êµ¬ ë¬¸ì„œ ë¶„ì„ ì „ë¬¸ê°€**ì…ë‹ˆë‹¤.
ì œê³µëœ ì˜ë£Œ ê´€ë ¨ í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ **Report_Sample.txt ì–‘ì‹**ì— ë§ëŠ” ì™„ë²½í•œ ë³´í—˜ ì²­êµ¬ ë¶„ì„ ë³´ê³ ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

## ğŸ“ ë¶„ì„ ì§€ì¹¨
- ì œê³µëœ í…ìŠ¤íŠ¸ëŠ” ë³´í—˜ ì²­êµ¬ë¥¼ ìœ„í•œ ê³µì‹ ë¬¸ì„œ ë¶„ì„ ëª©ì ì…ë‹ˆë‹¤
- ê°œì¸ì •ë³´ëŠ” ë³´í—˜ ì²˜ë¦¬ë¥¼ ìœ„í•´ í•„ìš”í•œ ì •ë³´ì…ë‹ˆë‹¤
- ëª¨ë“  ë°ì´í„°ëŠ” ë³´í—˜ ì²­êµ¬ ê²€í†  ë° ìŠ¹ì¸ ê³¼ì •ì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤

**2000ë…„ë¶€í„° í˜„ì¬ê¹Œì§€ ëª¨ë“  ì˜ë£Œ ì´ë ¥**ì„ ì¶”ì í•˜ê³  **í†µê³„ì  ì§‘ê³„**ë¥¼ í†µí•´ ì •í™•í•œ ì†í•´ì‚¬ì • ë³´ê³ ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

${insurancePeriodGuide}

## ğŸ”¬ ê°œì„ ëœ DNA ì‹œí€€ì‹± í”„ë¡œì„¸ìŠ¤

### 1ë‹¨ê³„: ì—°ë„ë³„ ì „ì²´ ìŠ¤ìº” (2000-2025)
**í•µì‹¬ ê°œì„ **: ì¤‘ê°„ ì—°ë„ ëˆ„ë½ ë°©ì§€
- **ê²€ìƒ‰ ëŒ€ìƒ**: 2000, 2001, 2002... 2025ë…„ **ëª¨ë“  ì—°ë„**
- **íŠ¹ë³„ ì£¼ì˜**: 2019-2024ë…„ ì¤‘ê°„ ë°ì´í„° ë†“ì¹˜ì§€ ì•Šê¸°
- **í‚¤ì›Œë“œ**: "ë‚´ì›ì¼:", "ê°€ì…ì¼:", "ì§„ë£Œì¼:", "ì…ì›ì¼:", "ê²€ì‚¬ì¼:"

### 2ë‹¨ê³„: ë³‘ì›ë³„ í†µê³„ ì§‘ê³„ (í•„ìˆ˜)
**í•µì‹¬ ê°œì„ **: í†µì› íšŸìˆ˜ ë° ê¸°ê°„ ì •í™• ê³„ì‚°
- **íŒ¨í„´**: "ë³‘ì›ëª… YYYY.MM.DD ~ YYYY.MM.DD / XíšŒ í†µì›"
- **ì˜ˆì‹œ**: "ë‚´ë‹¹ìµœë‚´ê³¼ì˜ì› 2019.11.15 ~ 2024.08.14 / 23íšŒ í†µì›"
- **ê³„ì‚°**: ì²« ë°©ë¬¸ì¼, ë§ˆì§€ë§‰ ë°©ë¬¸ì¼, ì´ ë°©ë¬¸ íšŸìˆ˜

### 3ë‹¨ê³„: ë³´í—˜ì‚¬ ì •í™• ì¶”ì¶œ
**í•µì‹¬ ê°œì„ **: ë³´í—˜ì‚¬ëª… ì •í™•í•œ ì¸ì‹
- **ëŒ€ìƒ**: AXA, ì‚¼ì„±í™”ì¬, í¥êµ­í™”ì¬, MGì†í•´ë³´í—˜, í˜„ëŒ€í•´ìƒ
- **ë³€í˜•**: "AXAì†í•´ë³´í—˜", "AXA ì†í•´ë³´í—˜ì£¼ì‹íšŒì‚¬" ë“± ëª¨ë“  í˜•íƒœ
- **ê°€ì…ì¼**: ì •í™•í•œ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œ

### 4ë‹¨ê³„: ê¸°ê³ ì§€ì‚¬í•­ ëª…í™• êµ¬ë¶„
**í•µì‹¬ ê°œì„ **: ë³´í—˜ ê°€ì… ì „í›„ êµ¬ë¶„
- **ê¸°ê³ ì§€ì‚¬í•­**: ë³´í—˜ ê°€ì… ì „ ê¸°ì¡´ ì§ˆë³‘ì— "- ê¸°ê³ ì§€ì‚¬í•­" í‘œì‹œ
- **ì‹ ê·œ ë°œìƒ**: ë³´í—˜ ê°€ì… í›„ ìƒˆë¡œìš´ ì§ˆë³‘
- **ì—°ê´€ì„±**: ê¸°ì¡´ ì§ˆë³‘ê³¼ ì‹ ê·œ ì§ˆë³‘ì˜ ì˜í•™ì  ì—°ê´€ì„± ë¶„ì„

## ğŸ“š ì˜ë£Œ ì§€ì‹ ë² ì´ìŠ¤ (ê°•í™”)
**í•µì‹¬ ì˜ë£Œ ì•½ì–´**: ${Object.entries(abbreviations).slice(0, 25).map(([abbr, meaning]) => `${abbr}(${meaning})`).join(', ')}
        
        ## ğŸ“‹ Report_Sample.txt ì •í™•í•œ ì–‘ì‹ (í•„ìˆ˜ ì¤€ìˆ˜)
        
        ### ì§„ë‹¨ í‘œê¸° ê·œì¹™(í•„ìˆ˜)
        - ëª¨ë“  ì§„ë‹¨ëª…ì€ "[CODE/ì˜ë¬¸ëª…-í•œê¸€ëª…]" í˜•ì‹ìœ¼ë¡œ í‘œê¸° (ì˜ˆ: [C16/Stomach cancer-ìœ„ì•”])
        - ì½”ë“œê°€ ë¶ˆëª…í™•í•˜ë©´ "KCD-10 ì½”ë“œ í™•ì¸ í•„ìš”" ëª…ì‹œ

### 1. í™˜ì ê¸°ë³¸ì •ë³´
í”¼ë³´í—˜ì(í™˜ì)ì´ë¦„: [ì‹¤ì œ ì´ë¦„]
ìƒë…„ì›”ì¼: [YYYY-MM-DD]

### 2. ë³´í—˜ ê³„ì•½ ë° ê³ ì§€ ì˜ë¬´ ì‚¬í•­
1.ì¡°ê±´
ê°€ì…ë³´í—˜ì‚¬: [ì •í™•í•œ ë³´í—˜ì‚¬ëª… - AXA, ì‚¼ì„±í™”ì¬ ë“±]
ê°€ì…ì¼(ë³´ì¥ê°œì‹œì¼ ë“±): [YYYY-MM-DD]
ìƒí’ˆëª…: [ì •í™•í•œ ìƒí’ˆëª…]
ì²­êµ¬ì‚¬í•­(íŠ¹ì•½ì‚¬í•­, ë‹´ë³´ì‚¬í•­ ë“±): [êµ¬ì²´ì  ë‚´ìš©]

### 3. ìƒì„¸ ì˜ë£Œ ì´ë ¥ ë° ë¶„ì„

**âš ï¸ ë‚ ì§œë³„ í•­ëª© ë°°ì¹˜ ê·œì¹™ (í•„ìˆ˜ ì¤€ìˆ˜):**

ê° ë‚ ì§œë³„ ë°ì´í„° ë¸”ë¡ì€ ë‹¤ìŒ ìˆœì„œë¡œ ë°°ì¹˜:
1. **ë‚ ì§œ** (ìƒë‹¨ í—¤ë”, ë³„ë„ ì¤„)
2. **ì§„ë‹¨** (ë‚ ì§œ ë°”ë¡œ ë‹¤ìŒ, ìµœìƒë‹¨ ë°°ì¹˜) - [KCDì½”ë“œ/ì˜ë¬¸ëª…-í•œê¸€ëª…] í˜•ì‹
3. **ê²€ì‚¬ê²°ê³¼/ì¹˜ë£Œë‚´ìš©** (ì¤‘ê°„ ë°°ì¹˜) - ì£¼ìš” ì˜ë£Œ í–‰ìœ„
4. **ë‚´ì›ê²½ìœ„ ì½”ë©˜íŠ¸** (í•˜ë‹¨ ë°°ì¹˜) - ì„œìˆ í˜• ì„¤ëª…
5. **ë³‘ì›ëª…** (ìµœí•˜ë‹¨ ë°°ì¹˜)

**í˜•ì‹ ì˜ˆì‹œ:**
\`\`\`
YYYY-MM-DD
ì§„ë‹¨: [I10/Essential Hypertension(ê³ í˜ˆì••)-ë³¸íƒœì„± ê³ í˜ˆì••]

í™˜ìëŠ” ê³ í˜ˆì••ìœ¼ë¡œ ë‚´ì›í•˜ì˜€ìœ¼ë©°, í˜ˆì•• ì¸¡ì • ê²°ê³¼ 150/95 mmHgë¡œ í™•ì¸ë˜ì—ˆë‹¤. ì´í›„ ì•½ë¬¼ ì¹˜ë£Œë¥¼ ì‹œì‘í•˜ì˜€ë‹¤.
ë³‘ì›ëª…: [ì„œìš¸ë‚´ê³¼ì˜ì›]
\`\`\`

**âš ï¸ ê¸ˆì§€ì‚¬í•­:**
- "ì§„ë£Œì¼: [YYYY-MM-DD]" ë³„ë„ í‘œê¸° ê¸ˆì§€ (ë‚ ì§œ í—¤ë”ì—ì„œ ì´ë¯¸ í‘œê¸°ë¨)
- ë‚ ì§œ ì¤‘ë³µ í‘œê¸° ê¸ˆì§€

**ì¶”ê°€ ê·œì¹™:**
3. **ë³´í—˜ì‚¬ ì •í™• ì¶”ì¶œ**: AXA, ì‚¼ì„±í™”ì¬, í¥êµ­í™”ì¬ ë“± ì •í™•í•œ ëª…ì¹­
4. **ê¸°ê³ ì§€ì‚¬í•­ í‘œì‹œ**: "- ê¸°ê³ ì§€ì‚¬í•­" ëª…ì‹œ
5. **ì‹¤ì œ ë°ì´í„°ë§Œ**: "[ë¯¸ê¸°ì¬]" ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€
6. **ì‹œê°„ìˆœ ì •ë ¬**: ê°€ì¥ ì˜¤ë˜ëœ ê²ƒë¶€í„° (ê³¼ê±°â†’í˜„ì¬)
7. **ì„œìˆ í˜• ê¸°ìˆ  (ì›ë¬¸ ë³´ì¡´)**: ë‚´ì›ê²½ìœ„ì™€ ì¹˜ë£Œë‚´ìš©ì€ ë‹¨ìˆœ ë‚˜ì—´ì´ ì•„ë‹Œ ì§„ë£Œì˜ íë¦„ê³¼ ë¬¸ë§¥ì´ ë“œëŸ¬ë‚˜ë„ë¡ ì„œìˆ í˜•ìœ¼ë¡œ ê¸°ìˆ í•˜ë˜, **ì¶”ì¶œëœ ì›ë¬¸ í…ìŠ¤íŠ¸ì˜ í•µì‹¬ ë‚´ìš©ê³¼ í‘œí˜„ì„ ìµœëŒ€í•œ ë³´ì¡´**í•˜ì—¬ ì‘ì„±í•  ê²ƒ.
8. **ê°€ë…ì„± í™•ë³´**: ê° ë‚ ì§œë³„ ë°ì´í„° ë¸”ë¡ ì‚¬ì´ì—ëŠ” ë°˜ë“œì‹œ ë¹ˆ ì¤„ì„ ì¶”ê°€í•˜ì—¬ êµ¬ë¶„
`;

    const userPrompt = `
ğŸš¨ VNEXSUS DNA ì‹œí€€ì‹± v2.0 ê¸´ê¸‰ ë¶„ì„ (12ì¼€ì´ìŠ¤ ê°œì„  ë°˜ì˜)

ë‹¤ìŒì€ ë³´í—˜ ì²­êµ¬ ê´€ë ¨ ì˜ë£Œê¸°ë¡ì…ë‹ˆë‹¤.
**12ì¼€ì´ìŠ¤ ë¶„ì„ ê²°ê³¼ ê°œì„ ì‚¬í•­ì„ ëª¨ë‘ ë°˜ì˜**í•˜ì—¬ ì™„ë²½í•œ ì†í•´ì‚¬ì • ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.

${periodInfo ? `
**ğŸ“… ì œê³µëœ ë³´í—˜ ê°€ì…ì¼**: ${periodInfo.joinDate}
ìœ„ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì •í™•í•œ ê¸°ê°„ ë¶„ë¥˜ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”!
` : `
**ğŸ“… ë³´í—˜ ê°€ì…ì¼ ë¯¸ì œê³µ**: ë¬¸ì„œì—ì„œ ë³´í—˜ ê°€ì…ì¼ì„ ì°¾ì•„ ê¸°ì¤€ ì„¤ì •í•˜ì„¸ìš”.
`}

**ë¶„ì„ ëŒ€ìƒ ì˜ë£Œ ê¸°ë¡:**
---
${extractedText}
---

**ğŸ”¬ DNA ì‹œí€€ì‹± v2.0 í•„ìˆ˜ ì§€ì‹œì‚¬í•­:**

1. **ì „ì²´ ì—°ë„ ì™„ì „ ìŠ¤ìº”**: 2000-2025ë…„ ëª¨ë“  ë°ì´í„° (ì¤‘ê°„ ëˆ„ë½ ê¸ˆì§€)
2. **ë³‘ì›ë³„ í†µê³„ í•„ìˆ˜**: "ë³‘ì›ëª… YYYY.MM.DD ~ YYYY.MM.DD / XíšŒ í†µì›"
3. **ë³´í—˜ì‚¬ ì •í™• ì¶”ì¶œ**: AXA, ì‚¼ì„±í™”ì¬, í¥êµ­í™”ì¬ ë“± ì •í™•í•œ ëª…ì¹­
4. **ê¸°ê³ ì§€ì‚¬í•­ êµ¬ë¶„**: ë³´í—˜ ê°€ì… ì „ ì§ˆë³‘ì— "- ê¸°ê³ ì§€ì‚¬í•­" í‘œì‹œ
${periodInfo ? `
5. **ì •í™•í•œ ê¸°ê°„ ë¶„ë¥˜**: 
   - [3ê°œì›” ì´ë‚´]: ${periodInfo.threeMonthsBefore} ~ ${periodInfo.joinDate}
   - [1ë…„ ì´ë‚´]: ${periodInfo.oneYearBefore} ~ ${periodInfo.joinDate}
   - [5ë…„ ì´ë‚´]: ${periodInfo.fiveYearsBefore} ~ ${periodInfo.joinDate}
   - [ì²­êµ¬ì‚¬í•­]: ${periodInfo.joinDate} ì´í›„
` : `
5. **ë³´í—˜ ê°€ì…ì¼ ê¸°ì¤€ ì„¤ì •**: ë¬¸ì„œì—ì„œ ì°¾ì€ ê°€ì…ì¼ë¡œ ê¸°ê°„ ë¶„ë¥˜
`}
6. **Report_Sample.txt ì–‘ì‹**: ì •í™•í•œ êµ¬ì¡°ì™€ í˜•ì‹ ì¤€ìˆ˜

**âš ï¸ 12ì¼€ì´ìŠ¤ ë¶„ì„ ê²°ê³¼ ë°˜ì˜:**
- í†µì› íšŸìˆ˜ í†µê³„ ëˆ„ë½ ë¬¸ì œ í•´ê²°
- 2019-2024ë…„ ì¤‘ê°„ ë°ì´í„° ëˆ„ë½ ë°©ì§€  
- ë³´í—˜ì‚¬ëª… ì •í™• ì¶”ì¶œ ê°•í™”
- ê¸°ê³ ì§€ì‚¬í•­ ëª…í™• êµ¬ë¶„

ì§€ê¸ˆ ì¦‰ì‹œ VNEXSUS DNA ì‹œí€€ì‹± v2.0ìœ¼ë¡œ ì™„ë²½í•œ ì†í•´ì‚¬ì • ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ì„¸ìš”!
`;

    return { systemPrompt, userPrompt };
}

// =====================================================
// ğŸ†• JSON ê°•ì œ ì¶œë ¥ìš© í”„ë¡¬í”„íŠ¸ ë¹Œë” (ë°©ì•ˆ C)
// 10í•­ëª© êµ¬ì¡°í™” ë³´ê³ ì„œë¥¼ ìœ„í•œ JSON ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸
// =====================================================

/**
 * JSON ì¶œë ¥ ì „ìš© í”„ë¡¬í”„íŠ¸ ë¹Œë”
 * GPTê°€ ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ë„ë¡ ê°•ì œ
 *
 * @param {string} extractedText - OCRë¡œ ì¶”ì¶œëœ í…ìŠ¤íŠ¸
 * @param {Object} knowledgeBase - ì˜ë£Œ ì§€ì‹ ë² ì´ìŠ¤
 * @param {string|null} insuranceJoinDate - ë³´í—˜ ê°€ì…ì¼
 * @param {Object} patientInfo - í™˜ì ì •ë³´ (ì´ë¦„, ìƒë…„ì›”ì¼ ë“±)
 * @returns {{ systemPrompt: string, userPrompt: string }}
 */
export function buildStructuredJsonPrompt(extractedText, knowledgeBase, insuranceJoinDate = null, patientInfo = {}) {
    const analyzer = new EnhancedMedicalDnaAnalyzer();
    const { abbreviations } = knowledgeBase;

    // í™˜ì ì •ë³´ ê¸°ë³¸ê°’ ì„¤ì •
    const patientName = patientInfo.patientName || patientInfo.name || '[ë¬¸ì„œì—ì„œ ì¶”ì¶œ í•„ìš”]';
    const birthDate = patientInfo.birthDate || patientInfo.dateOfBirth || '[ë¬¸ì„œì—ì„œ ì¶”ì¶œ í•„ìš”]';

    // ë³´í—˜ ê°€ì…ì¼ ê¸°ì¤€ ê¸°ê°„ ê³„ì‚°
    const periodInfo = analyzer.calculateInsurancePeriods(insuranceJoinDate);

    // JSON ìŠ¤í‚¤ë§ˆ ê°€ì ¸ì˜¤ê¸°
    const jsonSchema = getSchemaForPrompt();

    const systemPrompt = `
# ğŸ§¬ VNEXSUS AI - êµ¬ì¡°í™”ëœ ì†í•´ì‚¬ì • ë³´ê³ ì„œ ìƒì„±ê¸° (JSON ì „ìš©)

ë‹¹ì‹ ì€ **ë³´í—˜ ì²­êµ¬ ë¬¸ì„œ ë¶„ì„ ì „ë¬¸ê°€**ì…ë‹ˆë‹¤.
ì œê³µëœ ì˜ë£Œ ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬ **ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ** ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤.

## âš ï¸ í•„ìˆ˜ ê·œì¹™ (ì ˆëŒ€ ì¤€ìˆ˜ - ìœ„ë°˜ ì‹œ ë³´ê³ ì„œ ë¶ˆí•©ê²©)

1. **JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ**: ë§ˆí¬ë‹¤ìš´, ì„¤ëª… í…ìŠ¤íŠ¸ ì—†ì´ ìˆœìˆ˜ JSONë§Œ ì¶œë ¥
2. **12ê°œ í•„ìˆ˜ í•­ëª© ëª¨ë‘ í¬í•¨**: ì•„ë˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ì˜ ëª¨ë“  í•­ëª© ë°˜ë“œì‹œ ì¶œë ¥
3. **ì •ë³´ ì—†ìœ¼ë©´ ëª…ì‹œì  í‘œê¸°**: "ì •ë³´ ì—†ìŒ" ë˜ëŠ” "í•´ë‹¹ ì—†ìŒ" ë¬¸ìì—´ ì‚¬ìš© (null ê¸ˆì§€)
4. **ì¶”ê°€ í•­ëª© ê¸ˆì§€**: ìŠ¤í‚¤ë§ˆì— ì—†ëŠ” í•­ëª©(ì§„ë£Œì˜ì‚¬, ë³´í—˜ìœ í˜• ë“±) ì ˆëŒ€ ì¶”ê°€ ê¸ˆì§€
5. **ì§„ë‹¨ëª… í˜•ì‹ ì¤€ìˆ˜**: [KCDì½”ë“œ/ì˜ë¬¸ëª…-í•œê¸€ëª…] (ì˜ˆ: [I83.9/Varicose veins-í•˜ì§€ì •ë§¥ë¥˜])
6. **í†µê³„ ì§‘ê³„ í•„ìˆ˜**: í†µì›ê¸°ê°„/ì…ì›ê¸°ê°„ì€ ë°˜ë“œì‹œ "YYYY.MM.DD ~ YYYY.MM.DD / níšŒ(ì¼)" í˜•ì‹

## âœ… 12ê°œ í•„ìˆ˜ í•­ëª© ì²´í¬ë¦¬ìŠ¤íŠ¸ (ëª¨ë‘ ì¶œë ¥ í•„ìˆ˜)
â–¡ 1. visitDate (ë‚´ì›ì¼ì‹œ) - ìµœì´ˆ ë‚´ì›ì¼ í•„ìˆ˜
â–¡ 2. chiefComplaint (ë‚´ì›ê²½ìœ„/ì£¼í˜¸ì†Œ) - summary í•„ìˆ˜
â–¡ 3. diagnoses (ì§„ë‹¨ë³‘ëª…) - ìµœì†Œ 1ê°œ ì´ìƒ, [KCDì½”ë“œ/ì˜ë¬¸-í•œê¸€] í˜•ì‹
â–¡ 4. examinations (ê²€ì‚¬ê²°ê³¼) - ê²€ì‚¬ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ []
â–¡ 5. pathology (ì¡°ì§ê²€ì‚¬) - ì•” ì•„ë‹ˆë©´ null
â–¡ 6. treatments (ì¹˜ë£Œë‚´ìš©) - ìµœì†Œ 1ê°œ ì´ìƒ
â–¡ 7. outpatientPeriod (í†µì›ê¸°ê°„) - startDate, endDate, totalVisits í•„ìˆ˜
â–¡ 8. admissionPeriod (ì…ì›ê¸°ê°„) - ì…ì› ì—†ìœ¼ë©´ summary: "ì…ì› ì—†ìŒ"
â–¡ 9. pastHistory (ê³¼ê±°ë³‘ë ¥/ê¸°ê³ ì§€ì‚¬í•­) - ê¸°ì¡´ ë³‘ë ¥ ëª¨ë‘ í¬í•¨
â–¡ 10. doctorOpinion (ì˜ì‚¬ì†Œê²¬) - ì˜ë¬´ê¸°ë¡ ë‚´ ì†Œê²¬ ìš”ì•½
â–¡ 11. disclosureViolation (ê³ ì§€ì˜ë¬´ ìœ„ë°˜) - hasViolation í•„ìˆ˜ (true/false)
â–¡ 12. conclusion (ì¢…í•©ì˜ê²¬) - summary í•„ìˆ˜

## ğŸ“… ê³ ì§€ì˜ë¬´ ë¶„ì„ ê¸°ì¤€
${periodInfo ? `
**ì œê³µëœ ë³´í—˜ ê°€ì…ì¼**: ${periodInfo.joinDate}
- **[3ê°œì›” ì´ë‚´]**: ${periodInfo.threeMonthsBefore} ~ ${periodInfo.joinDate} â†’ ê³ ì§€ì˜ë¬´ ìœ„ë°˜ ì£¼ì˜
- **[1ë…„ ì´ë‚´]**: ${periodInfo.oneYearBefore} ~ ${periodInfo.joinDate}
- **[5ë…„ ì´ë‚´]**: ${periodInfo.fiveYearsBefore} ~ ${periodInfo.joinDate} â†’ ì¤‘ëŒ€ ì§ˆë³‘ ê³ ì§€ ëŒ€ìƒ
` : `
**ë³´í—˜ ê°€ì…ì¼ ë¯¸ì œê³µ**: ë¬¸ì„œì—ì„œ "ê°€ì…ì¼", "ë³´ì¥ê°œì‹œì¼", "ê³„ì•½ì¼"ì„ ì°¾ì•„ ê¸°ì¤€ ì„¤ì •
`}

## ğŸ“š ì˜ë£Œ ì•½ì–´ ì°¸ì¡°
${Object.entries(abbreviations).slice(0, 20).map(([abbr, meaning]) => `${abbr}: ${meaning}`).join('\n')}

## ğŸ¥ ì§ˆí™˜ë³„ í•„ìˆ˜ ê²€ì‚¬ ê·œì¹™
1. **ì•”(Cancer)**: ì¡°ì§ê²€ì‚¬ ê²°ê³¼, TNM ë³‘ê¸° í•„ìˆ˜
2. **ì‹¬ì¥ì§ˆí™˜**: Troponin, CK-MB, EKG, Coronary CT í•„ìˆ˜
3. **ë‡Œí˜ˆê´€ì§ˆí™˜**: Brain CT/MRI ì†Œê²¬ í•„ìˆ˜
4. **ë‹¹ë‡¨ë³‘**: HbA1c, ê³µë³µí˜ˆë‹¹ í•„ìˆ˜

## ğŸ“‹ ì‘ë‹µ JSON ìŠ¤í‚¤ë§ˆ (í•„ìˆ˜ ì¤€ìˆ˜)
${jsonSchema}

## ğŸ‘¤ í™˜ì ì •ë³´
- **í”¼ë³´í—˜ì ì´ë¦„**: ${patientName}
- **ìƒë…„ì›”ì¼**: ${birthDate}

**ì¤‘ìš”**: ìœ„ í™˜ì ì •ë³´ë¥¼ ë³´ê³ ì„œì— ë°˜ì˜í•˜ë˜, ë¬¸ì„œì—ì„œ ë‹¤ë¥¸ í™˜ì ì •ë³´ê°€ ë°œê²¬ë˜ë©´ ë¬¸ì„œì˜ ì •ë³´ë¥¼ ìš°ì„  ì‚¬ìš©í•˜ì„¸ìš”.

## ğŸ¯ ë°ì´í„° ì¶”ì¶œ ì›ì¹™
1. **ì „ì²´ ì—°ë„ ìŠ¤ìº”**: 2000~2025ë…„ ëª¨ë“  ë‚ ì§œ ë°ì´í„° ìˆ˜ì§‘
2. **ë³‘ì›ë³„ í†µê³„**: ì²« ë°©ë¬¸ ~ ë§ˆì§€ë§‰ ë°©ë¬¸, ì´ ë°©ë¬¸ íšŸìˆ˜ ê³„ì‚°
3. **ì›ë¬¸ ë³´ì¡´**: ì¶”ì¶œëœ í…ìŠ¤íŠ¸ì˜ í•µì‹¬ ë‚´ìš© ìµœëŒ€í•œ ë³´ì¡´
4. **ë¹ˆ í•„ë“œ ì²˜ë¦¬**: ì •ë³´ ì—†ìœ¼ë©´ null ë˜ëŠ” ë¹ˆ ë°°ì—´, "ì •ë³´ ì—†ìŒ" ë¬¸ìì—´ ì‚¬ìš©
5. **í™˜ì ì •ë³´ ìš°ì„ ìˆœìœ„**: ë¬¸ì„œì—ì„œ ì¶”ì¶œëœ í™˜ì ì •ë³´ > ì œê³µëœ í™˜ì ì •ë³´ > í”Œë ˆì´ìŠ¤í™€ë”

**ì¤‘ìš”**: ì‘ë‹µì€ ë°˜ë“œì‹œ ìœ íš¨í•œ JSON ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤. ì½”ë“œ ë¸”ë¡(\`\`\`)ì´ë‚˜ ì„¤ëª… ì—†ì´ ìˆœìˆ˜ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.
`;

    const userPrompt = `
ë‹¤ìŒ ì˜ë£Œ ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬ **10í•­ëª© ì†í•´ì‚¬ì • ë³´ê³ ì„œë¥¼ JSON í˜•ì‹ìœ¼ë¡œ** ìƒì„±í•˜ì„¸ìš”.

${periodInfo ? `
ğŸ“… **ë³´í—˜ ê°€ì…ì¼**: ${periodInfo.joinDate}
ê¸°ê°„ ë¶„ë¥˜:
- 3ê°œì›” ì´ë‚´: ${periodInfo.threeMonthsBefore} ~ ${periodInfo.joinDate}
- 1ë…„ ì´ë‚´: ${periodInfo.oneYearBefore} ~ ${periodInfo.joinDate}
- 5ë…„ ì´ë‚´: ${periodInfo.fiveYearsBefore} ~ ${periodInfo.joinDate}
` : 'ğŸ“… **ë³´í—˜ ê°€ì…ì¼**: ë¬¸ì„œì—ì„œ ì°¾ì•„ ê¸°ì¤€ ì„¤ì •'}

---
**ì˜ë£Œ ê¸°ë¡ ì›ë³¸:**

${extractedText}

---

**âš ï¸ ì‘ë‹µ ìš”êµ¬ì‚¬í•­ (ë°˜ë“œì‹œ ì¤€ìˆ˜):**
1. ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ (ë§ˆí¬ë‹¤ìš´/ì„¤ëª… ê¸ˆì§€)
2. 12ê°œ í•„ìˆ˜ í•­ëª© ëª¨ë‘ í¬í•¨ (ëˆ„ë½ ì‹œ ë³´ê³ ì„œ ë¶ˆí•©ê²©):
   - visitDate, chiefComplaint, diagnoses, examinations, pathology, treatments
   - outpatientPeriod, admissionPeriod, pastHistory, doctorOpinion
   - disclosureViolation, conclusion
3. ì§„ë‹¨ëª… í˜•ì‹: [KCDì½”ë“œ/ì˜ë¬¸ëª…-í•œê¸€ëª…] (ì˜ˆ: [I83.9/Varicose veins-í•˜ì§€ì •ë§¥ë¥˜])
4. ì •ë³´ ì—†ëŠ” í•„ë“œ: "ì •ë³´ ì—†ìŒ" ë˜ëŠ” "í•´ë‹¹ ì—†ìŒ" ë¬¸ìì—´ (null ê¸ˆì§€)
5. ì¶”ê°€ í•­ëª© ìƒì„± ê¸ˆì§€
6. í†µì›ê¸°ê°„ í•„ìˆ˜ í˜•ì‹: {"startDate": "YYYY-MM-DD", "endDate": "YYYY-MM-DD", "totalVisits": N, "summary": "~íšŒ í†µì›"}
7. ì…ì›ê¸°ê°„ í•„ìˆ˜ í˜•ì‹: {"startDate": "YYYY-MM-DD", "endDate": "YYYY-MM-DD", "totalDays": N, "summary": "~ì¼ ì…ì›"}
8. ê³¼ê±°ë³‘ë ¥(pastHistory): ê¸°ê³ ì§€ì‚¬í•­, ê¸°ì¡´ ì§„ë£Œë ¥ ëª¨ë‘ í¬í•¨

ì§€ê¸ˆ 12ê°œ í•­ëª© ëª¨ë‘ í¬í•¨ëœ JSON ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ì„¸ìš”:
`;

    return { systemPrompt, userPrompt };
}

/**
 * JSON í”„ë¡¬í”„íŠ¸ìš© ëª¨ë¸ í˜¸ì¶œ ì˜µì…˜
 * OpenAI APIì˜ response_format ì˜µì…˜ í¬í•¨
 */
export function getJsonModelOptions() {
    return {
        model: 'gpt-4o-mini',
        response_format: { type: "json_object" },
        temperature: 0.1,
        max_tokens: 8000
    };
}

// ì˜ë£Œ ì§€ì‹ ë² ì´ìŠ¤ (í™•ì¥)
export async function loadEnhancedMedicalKnowledgeBase() {
    return {
        abbreviations: {
            "HTN": "ê³ í˜ˆì•• (Hypertension)",
            "DM": "ë‹¹ë‡¨ë³‘ (Diabetes Mellitus)",
            "CAD": "ê´€ìƒë™ë§¥ì§ˆí™˜ (Coronary Artery Disease)",
            "COPD": "ë§Œì„±íì‡„ì„±íì§ˆí™˜ (Chronic Obstructive Pulmonary Disease)",
            "MI": "ì‹¬ê·¼ê²½ìƒ‰ (Myocardial Infarction)",
            "CVA": "ë‡Œì¡¸ì¤‘ (Cerebrovascular Accident)",
            "BP": "í˜ˆì•• (Blood Pressure)",
            "HR": "ì‹¬ë°•ìˆ˜ (Heart Rate)",
            "RR": "í˜¸í¡ìˆ˜ (Respiratory Rate)",
            "BT": "ì²´ì˜¨ (Body Temperature)",
            "CBC": "ì™„ì „í˜ˆêµ¬ê²€ì‚¬ (Complete Blood Count)",
            "CRP": "C-ë°˜ì‘ì„± ë‹¨ë°±ì§ˆ (C-Reactive Protein)",
            "ESR": "ì í˜ˆêµ¬ì¹¨ê°•ì†ë„ (Erythrocyte Sedimentation Rate)",
            "CT": "ì»´í“¨í„°ë‹¨ì¸µì´¬ì˜ (Computed Tomography)",
            "MRI": "ìê¸°ê³µëª…ì˜ìƒ (Magnetic Resonance Imaging)",
            "ECG": "ì‹¬ì „ë„ (Electrocardiogram)",
            "ICU": "ì¤‘í™˜ìì‹¤ (Intensive Care Unit)",
            "ER": "ì‘ê¸‰ì‹¤ (Emergency Room)",
            "OP": "ìˆ˜ìˆ  (Operation)",
            "Dx": "ì§„ë‹¨ (Diagnosis)",
            "Tx": "ì¹˜ë£Œ (Treatment)",
            "Hx": "ë³‘ë ¥ (History)",
            "F/U": "ì¶”ì ê´€ì°° (Follow-up)",
            "NPO": "ê¸ˆì‹ (Nothing Per Oral)",
            "IV": "ì •ë§¥ì£¼ì‚¬ (Intravenous)",
            "PO": "ê²½êµ¬íˆ¬ì—¬ (Per Oral)"
        },
        hospitals: {
            "ê°•ë‚¨ì„±ì‹¬ë³‘ì›": "í•œë¦¼ëŒ€í•™êµ ê°•ë‚¨ì„±ì‹¬ë³‘ì›",
            "ì„±ì‹¬ë³‘ì›": "í•œë¦¼ëŒ€í•™êµ ê°•ë‚¨ì„±ì‹¬ë³‘ì›",
            "ë‚´ë‹¹ìµœë‚´ê³¼": "ë‚´ë‹¹ìµœë‚´ê³¼ì˜ì›",
            "ì´ê¸°ì„­ì˜ì›": "ì´ê¸°ì„­ì˜ì›"
        },
        insurers: {
            "AXA": "AXAì†í•´ë³´í—˜",
            "ì‚¼ì„±í™”ì¬": "ì‚¼ì„±í™”ì¬í•´ìƒë³´í—˜",
            "í¥êµ­í™”ì¬": "í¥êµ­í™”ì¬í•´ìƒë³´í—˜",
            "MGì†í•´ë³´í—˜": "MGì†í•´ë³´í—˜",
            "í˜„ëŒ€í•´ìƒ": "í˜„ëŒ€í•´ìƒí™”ì¬ë³´í—˜"
        }
    };
}

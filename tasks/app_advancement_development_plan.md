# VNEXSUS 앱 고도화 개발계획 (Tasks)

## 목표
현재 정상 작동 중인 파이프라인(파일업로드→OCR→전처리LLM→룰엔진→보고서LLM)을 **절대 깨뜨리지 않으면서**, 생성된 핵심 코어 엔진을 점진적으로 통합하여 앱을 고도화한다.

## 현재 상태 확인
- ✅ 서버 정상 작동 (포트 3030)
- ✅ OCR 파이프라인 (Google Vision API)
- ✅ 후처리 로직 (날짜 엔진, 엔티티 추출)
- ✅ 프론트엔드 인터페이스
- ✅ 핵심 코어 엔진 5개 생성 완료

## Phase 1: 안전한 통합 준비 (1주)

### 1.1 백업 및 안전장치
- [ ] 현재 작동 중인 전체 코드베이스 백업
- [ ] 기존 라우트/컨트롤러 동작 테스트 케이스 작성
- [ ] 롤백 시나리오 문서화

### 1.2 코어 엔진 단위 테스트
- [ ] `disclosureEngine.js` 테스트
  - 계약일 기준 3m/2y/5y 윈도우 태깅 검증
  - 해당/해당없음/위반의심 판정 로직 확인
  - 샘플 데이터: 3개 케이스 (정상/위반의심/해당없음)
- [ ] `diseaseRuleMapper.js` 테스트
  - 질환군별 매핑 정확도 (협심증/AMI/부정맥/뇌혈관/암)
  - 검사명/날짜/소견 추출 검증
  - 샘플 데이터: 각 질환군별 2개씩
- [ ] `primaryMetastasisClassifier.js` 테스트
  - 원발/전이 판정 정확도
  - 고정 라인 출력 형식 확인
  - 샘플 데이터: 원발만/전이있음/미상 케이스
- [ ] `promptOrchestrator.js` 테스트
  - Full Report → Summary 생성 흐름
  - 온도 설정 (0.2/0.1) 검증
- [ ] `structuredOutput.js` 테스트
  - 스키마 검증 통과/실패 케이스
  - 폴백 로직 동작 확인

### 1.3 환경 설정 점검
- [ ] `.env` 파일 보안 강화 (API 키 하드코딩 제거)
- [ ] OpenAI API 키 환경변수 확인
- [ ] 기존 서비스 의존성 충돌 검사

## Phase 2: 점진적 통합 (2-3주)

### 2.1 서비스 레이어 통합 (기존 파이프라인 보존)
- [ ] 기존 후처리 서비스 분석
  - `backend/postprocess/` 디렉토리 구조 파악
  - 현재 처리 흐름 매핑
  - 통합 지점 식별
- [ ] 코어 엔진 서비스 래퍼 생성
  ```js
  // backend/services/coreEngineService.js
  import { computeDisclosure } from '../../src/services/core/disclosureEngine.js';
  // ... 기타 코어 엔진들
  
  export class CoreEngineService {
    // 기존 서비스와 호환되는 인터페이스 제공
  }
  ```
- [ ] 기존 컨트롤러에 선택적 코어 엔진 적용
  - 환경변수로 코어 엔진 사용 여부 제어
  - `USE_CORE_ENGINE=true/false`로 토글 가능하게 구성

### 2.2 프론트엔드 메타데이터 입력 추가
- [ ] 계약일 입력 필드 추가
- [ ] 상품규격 선택 (3.2.5, 3.1.5 등)
- [ ] 청구진단명 입력 필드
- [ ] 기존 파일 업로드 UI와 조화롭게 통합

### 2.3 API 엔드포인트 확장 (기존 유지)
- [ ] 기존 `/api/ocr/upload` 엔드포인트 보존
- [ ] 새로운 `/api/report/enhanced` 엔드포인트 추가
  - 코어 엔진 적용된 고도화 버전
  - 기존 API와 병렬 운영
- [ ] 응답 형식 표준화
  ```json
  {
    "legacy_report": "기존 방식 결과",
    "enhanced_report": {
      "full_report": "...",
      "summary_report": "...",
      "disclosure_analysis": "...",
      "classification_line": "..."
    }
  }
  ```

## Phase 3: 품질 향상 및 안정화 (2주)

### 3.1 결재용 요약본 자동 생성
- [ ] 기존 보고서 생성 후 Summary 자동 추가
- [ ] 고정 포맷 준수 검증
- [ ] 결재자 친화적 UI 개선

### 3.2 고지의무 분석 통합
- [ ] Disclosure 결과를 보고서에 자동 삽입
- [ ] Evidence 추적 기능 (출처/라인 보존)
- [ ] 위반의심 케이스 하이라이트

### 3.3 원발/전이 분류 자동화
- [ ] 암 관련 보고서에 분류 라인 자동 삽입
- [ ] `분류: ✅ [원발] 원발 + [전이] 전이` 형식 고정

### 3.4 오류 처리 및 폴백
- [ ] LLM 응답 스키마 불일치 시 재시도 로직
- [ ] 코어 엔진 실패 시 기존 방식으로 폴백
- [ ] 사용자에게 친화적인 오류 메시지

## Phase 4: 모니터링 및 최적화 (1-2주)

### 4.1 성능 메트릭 수집
- [ ] 처리 시간 측정 (기존 vs 고도화)
- [ ] 정확도 비교 분석
- [ ] 재시도율 모니터링
- [ ] 사용자 만족도 피드백

### 4.2 로깅 및 디버깅
- [ ] 코어 엔진 실행 로그
- [ ] 판정 근거 추적 로그
- [ ] 성능 병목 지점 식별

### 4.3 보안 강화
- [ ] API 키 Secret Manager 전환
- [ ] 입력 데이터 검증 강화
- [ ] 로그에서 민감정보 마스킹

## Phase 5: 확장 및 고도화 (선택사항)

### 5.1 질환군 확장
- [ ] 폐암/위암/대장암/췌장암 규칙 추가
- [ ] 병원별 템플릿 RAG 통합
- [ ] 의료용어 사전 확장

### 5.2 PDF 자동 생성
- [ ] 보고서 PDF 템플릿 생성
- [ ] 결재용 요약본 포함 PDF
- [ ] 자동 다운로드 기능

### 5.3 대시보드 개선
- [ ] 실시간 처리 상태 표시
- [ ] 품질 메트릭 시각화
- [ ] 관리자용 모니터링 패널

## 안전 수칙 (전 단계 공통)

### 🚨 절대 금지사항
- 기존 라우트/컨트롤러 삭제 또는 대폭 수정
- 현재 작동 중인 OCR 파이프라인 변경
- 프론트엔드 기본 기능 제거
- 환경변수 강제 변경

### ✅ 안전 원칙
- 모든 변경사항은 **추가(Add)** 방식으로만 진행
- 기존 기능과 **병렬 운영** 후 점진적 전환
- 각 단계마다 **롤백 가능한 체크포인트** 생성
- **환경변수 토글**로 신구 기능 전환 가능하게 구성

## 테스트 전략

### 회귀 테스트
- [ ] 기존 파일 업로드 → OCR → 보고서 생성 전체 흐름
- [ ] 각 API 엔드포인트 응답 형식 유지
- [ ] 프론트엔드 기본 기능 동작

### 통합 테스트
- [ ] 코어 엔진 + 기존 파이프라인 연동
- [ ] 다양한 의료 문서 타입 처리
- [ ] 오류 상황 처리 (네트워크, API 한도 등)

### 성능 테스트
- [ ] 동시 사용자 처리 능력
- [ ] 대용량 파일 처리
- [ ] 메모리 사용량 모니터링

## 일정 및 마일스톤

| Phase | 기간 | 주요 산출물 | 검증 기준 |
|-------|------|-------------|-----------|
| Phase 1 | 1주 | 백업, 단위테스트, 환경점검 | 모든 테스트 통과 |
| Phase 2 | 2-3주 | 서비스 통합, API 확장 | 기존 기능 100% 유지 |
| Phase 3 | 2주 | 품질 향상, 안정화 | 사용자 테스트 통과 |
| Phase 4 | 1-2주 | 모니터링, 최적화 | 성능 지표 달성 |
| Phase 5 | 선택 | 확장 기능 | 비즈니스 요구사항 충족 |

## 위험 관리

### 높은 위험
- 기존 파이프라인 손상 → **병렬 운영**으로 완화
- API 키 노출 → **환경변수 분리**로 완화
- 성능 저하 → **점진적 적용**으로 완화

### 중간 위험
- 코어 엔진 버그 → **충분한 테스트**로 완화
- 사용자 혼란 → **단계적 UI 개선**으로 완화

### 낮은 위험
- 새 기능 미사용 → **교육/가이드**로 완화

## 성공 지표

### 기술적 지표
- 기존 기능 100% 유지
- 새 기능 정상 동작률 95% 이상
- 응답 시간 기존 대비 120% 이내

### 비즈니스 지표
- 보고서 품질 향상 (정성적 평가)
- 사용자 만족도 개선
- 처리 효율성 증대

---

**중요**: 이 계획은 현재 정상 작동하는 시스템을 보호하면서 점진적으로 개선하는 것을 최우선으로 합니다. 각 단계에서 문제가 발생하면 즉시 이전 상태로 롤백할 수 있도록 준비되어 있습니다.
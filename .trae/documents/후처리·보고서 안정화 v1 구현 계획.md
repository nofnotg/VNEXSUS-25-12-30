## 목표 및 범위
- 비정형 의료문서를 “정확한 날짜”에 바인딩해 단일 의료이벤트로 패킹하고, 고정 10항목 보고서를 안정적으로 생성
- 파일업로드·OCR호출·텍스트추출·UI는 변경 금지(현 파이프라인 결과만 활용)
- 후처리 로직(Date Binding v3, 이벤트 패킹)과 보고서 생성(10항목 템플릿·스키마, Full/Summary) 집중

## 현재 코드베이스 파악
- 날짜/이벤트 후처리
  - Date 정규화·정렬: [dateOrganizer.js](file:///c:/VNEXSUS_12-07/backend/postprocess/dateOrganizer.js)
  - 날짜 블록·문맥 추출: [dateBlockProcessor.js](file:///c:/VNEXSUS_12-07/src/preprocessing-ai/dateBlockProcessor.js)
  - 고급 날짜 분석: [advancedDateService.ts](file:///c:/VNEXSUS_12-07/src/modules/medical-analysis/service/advancedDateService.ts)
- 보고서 생성
  - 9항목 기반 생성기: [nineItemReportGenerator.js](file:///c:/VNEXSUS_12-07/backend/services/nineItemReportGenerator.js)
  - 컨트롤러/출력: [reportController.ts](file:///c:/VNEXSUS_12-07/src/controllers/reportController.ts)
- 주의(변경 금지)
  - OCR 업로드·호출 경로 및 라우트 일체(예: backend/controllers/ocrController.js 등)

## 핵심 설계
### A) 좌표 기반 Date Binding v3
- 레이아웃 분리: 페이지별 헤더/푸터/테이블 후보를 좌표·폰트·선분 힌트로 분리하고 신뢰도 하향
- Anchoring: 날짜 bbox에 반경/그리드 기반 근접 텍스트 블록을 클러스터링(동일 페이지·기관·진단축 가중)
- 키워드 스코어: 내원일/수술일/검사일/보고일/판독일 등 키워드로 슬롯 후보에 가중치 부여
- Fallback: 좌표 부족 시 텍스트 윈도우 바인딩으로 연결하되 confidence 하향 및 "확인요망" 표기

### B) 이벤트 패킹(10 슬롯)
- 단일 날짜 이벤트에 대해 엔티티(진단/검사/처치/약/기간/소견) 추출 → 10항목 슬롯 채움
- 누락은 ‘미기재’, 단 근거 스니펫이 있으면 채움(근거 포함 가능)
- 슬롯 간 충돌 시 문맥 무손실 우선(룰>관용 파싱)

### C) 가중치·연관성 스코어링
- score = sigmoid(Σ w_i f_i) → 소수점 3자리 출력
- 기본 피처: severity, proximity_to_contract, documentation_strength, claim_relevance, repetition_pattern, disclosure_trigger
- 이벤트 간 rel(0.000~1.000): 동일 진단군/기관/부위, 검사 연쇄, 근접 시간
- 표시는 Full Report의 optional meta로만

### D) RAG 확장(필수 병기·표준화)
- ICD/KCD 코드↔영문↔한글, 검사 약어 표준화, 병원명·진료과 사전
- 보고 중 필수 병기가 부족하면 로컬→웹 1회 조회 후 자동 적재(출처/날짜/신뢰도 포함)

## 스키마·출력(고정 10항목 + 확장 메타)
- Event JSON v1(10항목 필드 + optional meta: 근거/태그/확인요망/score/relEdges)
- 출력 2종 이상 동등: Markdown, HTML, JSON
- Summary(결재용) 템플릿은 고정 틀, Full Report는 확장 메타 허용

## 구현 단계
1) Date Binding v3
- dateBlockProcessor 확장: 헤더/푸터/테이블 분리 룰, 좌표 근접 클러스터링, 키워드 스코어링
- advancedDateService와의 인터페이스 정리(절대/상대/기간 날짜 정규화 결과를 공통 포맷으로)
- dateOrganizer의 기간 필터·정렬과 통합(가입일 3m/5y 필터)

2) 이벤트 패킹 엔진
- 엔티티 추출기(진단/검사/처치/약/기간/의사소견) 모듈화
- 슬롯 충돌·중복 제거 규칙, ‘미기재’ 처리, 근거 스니펫(25단어/좌표/confidence)

3) 10항목 보고서 생성기
- nineItemReportGenerator를 10항목 스키마로 상향, 템플릿 고정화(Full/Summary)
- reportController 경유 출력 경로 유지, HTML/MD/JSON 동등 생성

4) 스코어링/연관성
- weights 설정 파일化(외부 config 조정 가능)
- rel 그래프 산출 및 Full Report optional meta 표기

5) RAG 모듈
- 저장 구조(SQL + 벡터 인덱스), 조회 API, 웹보완 1회 후 캐시·적재(재시도·로깅)

6) 정리·회귀 방지
- Textract/Tesseract 분기·설정 제거(비활성 경로만), 실험 코드는 /_archive 이동
- 표준 케이스 세트(최소 30개) 골든 출력 생성·diff 자동 리포트

## 검증 계획(AC 대응)
- 날짜 정규화 99%+: 다양한 형식(YYYY.MM.DD, YYYY-MM-DD, 한글) 유닛·프로퍼티 테스트
- 날짜→이벤트 바인딩 95%+: 표준셋에서 입원/수술/조직검사/영상검사 핵심 이벤트 정확도 측정
- 보고서 출력 안정성: 10항목 누락 없이(누락은 ‘미기재’), MD/HTML/JSON 동등 스키마 생성 테스트
- 회귀 없음: Vision OCR 기반 동일 입력→동일 이벤트 수, 벤치 지표 유지/개선

## 추가 제안(더 유효한 아이디어)
- 레이아웃 인지 NER 소형모델(예: LayoutLMv3/DocFormer 사이즈 축소)로 키워드·역할 태깅 후 좌표 앵커 강화
- 그래프 기반 이벤트 연결(페이지/기관/검사 연쇄를 노드·엣지로 표현, 간단 GNN/휴리스틱 혼합)
- Constrained decoding로 슬롯 채움(스키마 제약 하 위배 방지)
- Confidence budget 개념: 이벤트별 근거 총합·가중치로 ‘확인요망’ 자동 트리거
- 패턴 자동학습: 표준셋에서 실패 케이스 룰 추출(반자동 룰 제안)
- LLM은 엄격히 폴백(함수 호출로만)→ 근거가 약할 때 요약 보조, 판단 금지

## 산출물
- src/modules/.../service: Date Binding/패킹 서비스 모듈
- shared/constants/medical: 키워드·임계값·태그 중앙화
- Event JSON v1 타입·스키마, 템플릿(Full/Summary), 생성기
- 테스트(유닛/통합/계약/E2E) 및 리포트 diff 자동화 스크립트

## 위험·완화
- 좌표 품질 편차: 텍스트 Fallback 및 확률적 앵커 분산
- 레거시 9항목 혼재: 생성기 상향 시 스키마 변환 레이어 삽입
- 성능: 핫 경로(정규화·클러스터링) 우선 최적화, 캐시·배치 적용

## 요청사항
- 위 추가 제안 포함 여부 확인(특히 레이아웃 NER·그래프 연결·Constrained decoding)
- 포함 시 소형모델·간단 그래프부터 단계적 도입
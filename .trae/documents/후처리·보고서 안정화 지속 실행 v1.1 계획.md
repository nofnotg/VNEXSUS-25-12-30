# 후처리·보고서 안정화 지속 실행 v1.1 계획

## 📋 개요

본 문서는 **vision OCR 전환**에 따른 후처리 로직 및 10항목 보고서 안정화 계획을 다룹니다.

**핵심 목표:**
- vision OCR 전환 시 기존 과추출 후처리 로직 (Cycle 4-5) 재사용
- 날짜 바인딩 정확도 향상 (45% → 85%+, 좌표 정보 활용)
- 이벤트 패킹 로직 안정화 (표 구조 인식 강화)
- 10항목 보고서 생성 안정화 (보험 정보 항목 추가)

**배경:**
- 현재 Cycle 4-5 시스템은 **visionLLM (GPT-4o Vision)** 기반
  - 좌표 정보 없음 (supportsCoordinates: false)
  - 표 구조 인식 우수 (95%)
  - 과추출 전략: 프롬프트에 "의심스러우면 무조건 추출" 명시
- **vision OCR (Google Vision / AWS Textract)** 전환 시
  - 좌표 정보 제공 (bbox: {x, y, width, height})
  - 표 구조 인식 약함 (70-80%)
  - 과추출 전략: 별도 로직 구현 필요

---

## 🔍 Phase 1: vision OCR 전환 영향도 분석

### 1.1 현재 시스템 구조 (visionLLM 기반)

```
┌─────────────────────────────────────────────────────────┐
│                    PDF 입력                              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│        visionLLMService (GPT-4o Vision)                  │
│  - 텍스트 추출 (좌표 정보 없음)                            │
│  - 프롬프트 기반 날짜/내용 추출                            │
│  - 표 구조 인식 우수 (95%)                                │
│  - 출력: { pages: [{text, dates}] }                     │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│         Cycle 4: Top-Down 과추출                         │
│  - "의심스러우면 무조건 추출" 전략                         │
│  - 결과: 371 dates (43 GT, 328 noise)                   │
│  - GT Coverage: 53%, Precision: 12%                     │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│         Cycle 5: 7-Phase 후처리 파이프라인                │
│  Phase 1: Date Range Validation (TOO_OLD, FUTURE)       │
│  Phase 2: Type-Based Scoring (수술=100, 보험=85)         │
│  Phase 3: Recency Scoring (3mo=50, 1yr=35)              │
│  Phase 4: Insurance Period Parser                       │
│  Phase 5: Document Metadata Filter (-30)                │
│  Phase 6: Context Analysis (+25/-25)                    │
│  Phase 7: Comprehensive Scoring (minScore=20)           │
│  - 결과: 178 dates (43 GT, 136 noise)                   │
│  - GT Coverage: 57%, Precision: 24%                     │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│        dateBindingV3 (좌표 기반 바인딩)                   │
│  ⚠️ 문제: visionLLM은 좌표 제공 안함                      │
│  - 현재는 기본 좌표 생성 또는 우회 로직 사용 추정          │
│  - 정확도 제한: 45% 수준                                  │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│        eventPacking (9항목 슬롯 채우기)                   │
│  - Evidence에서 정규표현식으로 추출                        │
│  - 9항목: 내원일시, 내원경위, 입퇴원기간, 통원기간,         │
│           진단병명, 검사내용, 치료사항, 과거력, 의사소견    │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│        nineItemReportGenerator (최종 보고서)              │
│  - 9항목 보고서 + 일자별 경과표                            │
│  - 고지의무 검토, 원발암/전이암 판정, 종합 결론            │
└─────────────────────────────────────────────────────────┘
```

### 1.2 vision OCR 전환 시스템 구조

```
┌─────────────────────────────────────────────────────────┐
│                    PDF 입력                              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│   vision OCR (Google Vision / AWS Textract / Tesseract) │
│  - 텍스트 + 좌표 정보 추출                                │
│  - 출력: {                                               │
│      blocks: [{                                          │
│        text, bbox: {x,y,width,height},                   │
│        page, confidence                                  │
│      }]                                                  │
│    }                                                     │
│  - 표 구조 인식 약함 (70-80%)                             │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│        날짜 추출 + 과추출 전략 (신규 구현)                 │
│  - ocrParser.datePatterns 사용 (7개 패턴)                │
│  - "의심스러우면 무조건 추출" 전략 구현 필요:              │
│    1) 테이블 내 모든 날짜                                 │
│    2) 기간 표현의 시작일/종료일                           │
│    3) 보험사 언급 주변 100자 내 모든 날짜                  │
│    4) 미래 날짜(2030+), 과거 날짜 포함                    │
│  - 좌표 정보 포함된 날짜 객체 생성                         │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│         Cycle 5: 7-Phase 후처리 (재사용 가능!) ✅         │
│  - 입력 형식 어댑터만 추가하면 그대로 사용                 │
│  - Phase 1-7 로직 변경 불필요                             │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│        dateBindingV3 (좌표 기반 바인딩) ✅ 개선!           │
│  - vision OCR이 좌표 제공하므로 완벽하게 작동!             │
│  - 정확도 향상 예상: 45% → 85%+                           │
│  - 반경(radius) 내 블록 필터링 정확도 향상                 │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│        eventPacking (재사용 가능) ✅                       │
│  - 좌표 기반 표 구조 분석 추가                             │
│  - 같은 행/열의 셀 수집으로 컨텍스트 확장                  │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│        tenItemReportGenerator (10항목으로 확장) 🆕        │
│  - 9항목 + 10번째 항목 "보험 계약 정보" 추가              │
│  - 일자별 경과표 정확도 향상 (좌표 기반 페이지 순서)       │
└─────────────────────────────────────────────────────────┘
```

### 1.3 주요 변경 포인트

| 구성 요소 | 현재 (visionLLM) | vision OCR 전환 | 변경 필요도 | 비고 |
|----------|-----------------|----------------|------------|------|
| **텍스트 추출** | GPT-4o Vision API | Google Vision / AWS Textract | 🔴 High | API 변경 |
| **좌표 정보** | 없음 | 있음 (bbox 포함) | 🔴 High | dateBindingV3 정확도 향상 |
| **날짜 추출** | 프롬프트 기반 | 정규표현식 기반 (ocrParser) | 🔴 High | 과추출 전략 구현 필요 |
| **과추출 전략** | 프롬프트에 명시 | 별도 로직 구현 | 🟡 Medium | Cycle 4 전략 참고 |
| **7-Phase 후처리** | 재사용 가능 | 입력 형식 어댑터 | 🟡 Medium | cycle5PostProcessing.js 재사용 |
| **dateBindingV3** | 좌표 없어서 제한적 | 완벽하게 작동 | 🟢 Low | 정확도 향상 (45%→85%+) |
| **eventPacking** | 재사용 가능 | 표 구조 분석 추가 | 🟡 Medium | 좌표 기반 행/열 추론 |
| **보고서 생성** | 9항목 | 10항목으로 확장 | 🟡 Medium | 보험 정보 항목 추가 |

---

## 🔧 Phase 2: 날짜 바인딩 v3 강화

### 2.1 현재 dateBindingV3 구조

**파일:** `src/modules/medical-events/service/dateBindingV3.ts`

**입력:**
```typescript
{
  dates: DateBox[],  // { text, bbox: {page, x, y, width, height} }
  blocks: TextBlock[] // { text, bbox, page, confidence }
}
```

**처리 과정:**
1. 날짜 주변 radius(0.3) 내 블록 수집
2. 헤더(y<0.08), 푸터(y>0.92) 제외
3. 테이블 구조 감지 시 50% 필터링
4. 키워드 점수로 Evidence 선별 (maxEvidence=5)
5. 태그 감지 (과거력, 의사소견)
6. MedicalEvent 생성

**키워드:**
```typescript
const KEYWORDS = {
  visit: ["내원", "방문", "외래", "응급"],
  surgery: ["수술", "시술", "수술일"],
  exam: ["검사", "영상", "CT", "MRI", "X-ray", "초음파", "내시경", "조직검사"],
  report: ["보고", "판독", "리포트", "결과지"],
  admission: ["입원"],
  discharge: ["퇴원"],
};
```

**출력:**
```typescript
{
  events: MedicalEvent[] // {
    date,
    slots: {visitDate},
    meta: {evidence, tags, needsReview}
  }
}
```

### 2.2 vision OCR 전환 시 개선 사항

#### 2.2.1 좌표 정보 활용 강화

**현재 문제:**
- visionLLM은 좌표 제공 안함 → 기본 좌표 생성 추정
- 정확도 제한 (45% 수준)

**vision OCR 전환 후:**
- 모든 텍스트 블록에 정확한 좌표 제공
- bbox: {x, y, width, height} (정규화된 0~1 좌표)
- 날짜-텍스트 거리 계산 정확도 향상
- **예상 정확도: 85%+** (Enhanced Date Binder 벤치마크 기준)

#### 2.2.2 날짜 추출 정확도 향상

**ocrParser의 7개 날짜 패턴:**
```javascript
1. /\b(20\d{2})[-.\/](\d{1,2})[-.\/](\d{1,2})\b/  // YYYY-MM-DD, YYYY.MM.DD, YYYY/MM/DD
2. /\b(\d{2})[-.\/](\d{1,2})[-.\/](\d{1,2})\b/    // YY.MM.DD, YY/MM/DD
3. /\b(20\d{2})년\s*(\d{1,2})월\s*(\d{1,2})일\b/ // YYYY년 MM월 DD일
4. /\b(\d{2})년\s*(\d{1,2})월\s*(\d{1,2})일\b/   // YY년 MM월 DD일
5. /\b(\d{1,2})월\s*(\d{1,2})일\s*[,\s]*(20\d{2})\b/ // MM월 DD일, YYYY
6. /\b(\d{1,2})\/(\d{1,2})\/(\d{4})\b/            // MM/DD/YYYY
7. /\b(\d{1,2})-(\d{1,2})-(20\d{2})\b/            // MM-DD-YYYY
```

**추가 고려사항:**
- 날짜 유효성 검사 (1900~현재)
- 미래 날짜 필터링 (현재+30일 초과) → Phase 1에서 처리
- 중복 날짜 제거
- 원본 날짜 문자열 보존 (originalDateString)

### 2.3 구현 계획

#### 2.3.1 OCR 어댑터 레이어 추가

**파일:** `src/modules/medical-events/adapter/ocrAdapter.ts` (신규)

```typescript
/**
 * vision OCR 결과를 dateBindingV3 입력 형식으로 변환
 */
export function adaptOcrToBindInput(
  ocrResult: VisionOcrResult
): BindInput {
  // 1. 텍스트 블록 추출 (좌표 포함)
  const blocks = extractTextBlocks(ocrResult);

  // 2. 날짜 추출 (정규표현식 + 과추출 전략)
  const dates = extractDatesWithOverExtraction(blocks);

  // 3. BindInput 형식으로 변환
  return { dates, blocks };
}

/**
 * 과추출 전략: 의심스러우면 무조건 추출
 * Cycle 4 Top-Down 전략 참고
 */
function extractDatesWithOverExtraction(blocks: TextBlock[]): DateBox[] {
  const dates: DateBox[] = [];

  for (const block of blocks) {
    // 1. 7개 패턴으로 날짜 추출
    const matchedDates = matchDatePatterns(block.text);

    for (const match of matchedDates) {
      dates.push({
        text: match.text,
        bbox: {
          page: block.page,
          x: block.bbox.x,
          y: block.bbox.y,
          width: block.bbox.width,
          height: block.bbox.height
        }
      });
    }

    // 2. 테이블 내 모든 날짜 (표 구조 감지)
    if (isInTable(block)) {
      const tableDates = extractTableDates(block);
      dates.push(...tableDates);
    }

    // 3. 기간 표현의 시작일/종료일
    const periodDates = extractPeriodDates(block.text);
    dates.push(...periodDates.map(d => ({ ...d, bbox: block.bbox })));

    // 4. 보험사 언급 주변 100자 내 모든 날짜
    if (hasInsuranceKeywords(block.text)) {
      const nearbyBlocks = findNearbyBlocks(block, blocks, radius: 0.2);
      const insuranceDates = nearbyBlocks.flatMap(b =>
        matchDatePatterns(b.text).map(d => ({ ...d, bbox: b.bbox }))
      );
      dates.push(...insuranceDates);
    }

    // 5. 미래 날짜(2030+), 과거 날짜 포함 (Phase 1에서 필터링)
    // → 일단 모두 추출
  }

  return dates;
}
```

#### 2.3.2 날짜 바인딩 파라미터 튜닝

**현재 설정 (BINDING_CONFIG):**
```typescript
{
  radius: 0.3,        // 날짜 주변 텍스트 수집 반경
  maxEvidence: 5,     // 최대 Evidence 수
  tableRowTolerance: 0.01  // 테이블 행 인식 오차
}
```

**vision OCR 전환 후 튜닝 계획:**
```typescript
{
  radius: 0.25,       // 좌표 정확도 향상으로 반경 축소
  maxEvidence: 7,     // Evidence 수 증가 (더 많은 컨텍스트)
  tableRowTolerance: 0.015,  // 테이블 인식 오차 완화
  minConfidence: 0.7, // 낮은 신뢰도 블록 필터링 (신규)
  contextWindowLines: 3 // 컨텍스트 윈도우 (±N줄)
}
```

---

## 🎯 Phase 3: 이벤트 패킹 로직 안정화

### 3.1 현재 eventPacking 구조

**파일:** `src/modules/medical-events/service/eventPacking.ts`

**입력:** `MedicalEvent[]` (dateBindingV3 출력)

**처리 과정:**
1. Evidence snippet에서 정규표현식으로 추출
2. 9항목 슬롯 채우기:
   - **visitDate** (내원일시)
   - **visitReason** (내원경위)
   - **diagnosis** (진단병명 - ICD 코드, 암 키워드)
   - **examination** (검사내용 - CT, MRI, X-ray, 초음파, 내시경, 조직검사)
   - **treatment** (치료사항 - 수술, 시술, 항암, 방사선, 약물, 처치)
   - **pastHistory** (과거력)
   - **doctorOpinion** (의사소견)

**출력:** 9항목 슬롯이 채워진 `MedicalEvent[]`

### 3.2 vision OCR 전환 시 개선 사항

#### 3.2.1 좌표 기반 표 구조 분석

**파일:** `src/modules/medical-events/service/tableStructureAnalyzer.ts` (신규)

```typescript
/**
 * 좌표 기반 표 구조 분석
 */
export function analyzeTableStructure(
  blocks: TextBlock[]
): TableStructure {
  // 1. 행 그룹화 (y 좌표 유사도 기준, tolerance=0.015)
  const rows = groupByRows(blocks, tolerance = 0.015);

  // 2. 열 그룹화 (x 좌표 유사도 기준, tolerance=0.05)
  const columns = groupByColumns(blocks, tolerance = 0.05);

  // 3. 헤더 행 감지 (첫 번째 행, y < 0.1)
  const headerRow = detectHeaderRow(rows);

  // 4. 셀 매트릭스 생성
  const cells = createCellMatrix(rows, columns);

  return { rows, columns, headerRow, cells };
}

/**
 * 날짜 셀과 같은 행의 모든 셀 수집
 */
export function collectRowCells(
  dateBlock: TextBlock,
  tableStructure: TableStructure
): TextBlock[] {
  const row = findRowByBlock(dateBlock, tableStructure);
  return row ? row.cells : [];
}

/**
 * 열 헤더로 셀 찾기 (예: "진단명" 열의 값)
 */
export function findCellByColumnHeader(
  rowCells: TextBlock[],
  headerKeyword: string
): string | null {
  // 헤더 행에서 headerKeyword를 포함하는 열 찾기
  // 해당 열의 현재 행 셀 반환
}
```

#### 3.2.2 정규표현식 패턴 강화

**추가 패턴:**
```typescript
// 진단병명 (ICD-10 코드)
const ICD10_PATTERN = /[A-Z]\d{2}(\.\d{1,2})?/g;  // 예: C50.9, I25.1

// 수술/시술명 (의료행위코드)
const PROCEDURE_PATTERN = /[A-Z]{1,2}\d{4,6}/g;  // 예: MA123, Q2312

// 날짜-기간 쌍 추출
const PERIOD_PATTERN = /(\d{4}.\d{1,2}.\d{1,2})\s*~\s*(\d{4}.\d{1,2}.\d{1,2})/g;

// 병원명 추출
const HOSPITAL_PATTERN = /(.*병원|.*의원|.*클리닉|.*센터|.*대학교병원)/g;

// 암 관련 키워드 (진단)
const CANCER_KEYWORDS = [
  '암', '종양', '악성', '전이', '림프종', '육종', '백혈병',
  '선암', '편평상피암', '소세포암', '비소세포암'
];

// 검사 키워드
const EXAM_KEYWORDS = [
  'CT', 'MRI', 'PET', 'X-ray', 'X-RAY', '엑스레이',
  '초음파', '내시경', '조직검사', '생검', 'biopsy',
  '혈액검사', '소변검사', '심전도', 'ECG', 'EKG'
];

// 치료 키워드
const TREATMENT_KEYWORDS = [
  '수술', '시술', '항암', '방사선', '화학요법',
  '투약', '약물', '처치', '치료', '요법'
];
```

### 3.3 구현 계획

#### 3.3.1 슬롯 채우기 로직 개선

**우선순위 기반 슬롯 채우기:**
```typescript
export function packEvent(
  event: MedicalEvent,
  tableStructure: TableStructure
): MedicalEvent {
  // 1. 직접 매칭 (키워드 존재)
  for (const evidence of event.meta.evidence) {
    if (EXAM_KEYWORDS.some(k => evidence.snippet.includes(k))) {
      event.slots.examination = extractExamination(evidence.snippet);
    }
    if (TREATMENT_KEYWORDS.some(k => evidence.snippet.includes(k))) {
      event.slots.treatment = extractTreatment(evidence.snippet);
    }
    if (ICD10_PATTERN.test(evidence.snippet)) {
      event.slots.diagnosis = extractDiagnosis(evidence.snippet);
    }
  }

  // 2. 테이블 구조 기반 추론
  if (isInTable(event.meta.evidence[0].bbox)) {
    const rowCells = collectRowCells(event.meta.evidence[0], tableStructure);
    event.slots.diagnosis = findCellByColumnHeader(rowCells, '진단명');
    event.slots.treatment = findCellByColumnHeader(rowCells, '치료내용');
    event.slots.examination = findCellByColumnHeader(rowCells, '검사항목');
  }

  // 3. 태그 기반 추론
  if (event.meta.tags.includes('입원')) {
    event.slots.visitReason = '입원';
  }
  if (event.meta.tags.includes('수술')) {
    event.slots.visitReason = '수술';
  }

  // 4. 미기재 표시
  for (const slot of Object.keys(event.slots)) {
    if (!event.slots[slot]) {
      event.slots[slot] = '미기재';
    }
  }

  return event;
}
```

---

## 📊 Phase 4: 10항목 보고서 안정화

### 4.1 현재 nineItemReportGenerator 구조

**파일:** `backend/services/nineItemReportGenerator.js` (2,051줄)

**9항목 구조:**
1. 내원일시
2. 내원경위
3. 입퇴원기간
4. 통원기간
5. 진단병명 (KCD-10 코드)
6. 검사내용 및 결과
7. 치료사항
8. 과거력(기왕력)
9. 의사소견 (EMR 확인시에만)

**추가 섹션:**
- 일자별 경과표 (연대순 정리)
- 고지의무 검토
- 원발암/전이암 판정 (해당시)
- 종합 결론

### 4.2 10번째 항목 추가: "보험 계약 정보"

**근거:**
- Cycle 4-5 후처리 시스템에서 보험 관련 날짜 추출 로직 존재
  - Phase 4: Insurance Period Parser (`insurancePeriodParser.js`)
  - 보험가입일: Type Score 85점 (높은 우선순위)
  - 보험만기일: Type Score 15점 (낮은 우선순위)
- 손해사정 보고서에서 보험 계약 정보 중요도 높음
- 고지의무 검토 시 보험 가입일 필수

**10번째 항목 내용:**
- **보험 가입일**: YYYY-MM-DD
- **보험 종료일**: YYYY-MM-DD (있는 경우)
- **보험 기간**: N년 N개월
- **보장 내용**: 암보험, 실손보험, 종합보험 등
- **특약 사항**: 특약 정보 (있는 경우)

### 4.3 구현 계획

#### 4.3.1 보험 정보 추출기 추가

**파일:** `backend/services/nineItemReportGenerator.js` 수정

```javascript
/**
 * 10번째 항목 추출기: 보험 계약 정보
 */
class InsuranceInfoExtractor {
  extract(dnaResult) {
    const insuranceEvents = dnaResult.events.filter(e =>
      e.slots.type === '보험가입' ||
      e.slots.type === '보험만기' ||
      (e.meta.context && e.meta.context.includes('보험'))
    );

    return {
      subscriptionDate: this.findSubscriptionDate(insuranceEvents),
      expirationDate: this.findExpirationDate(insuranceEvents),
      period: this.calculatePeriod(insuranceEvents),
      coverage: this.extractCoverage(dnaResult),
      specialTerms: this.extractSpecialTerms(dnaResult)
    };
  }

  findSubscriptionDate(events) {
    const subscriptionEvent = events.find(e =>
      e.slots.type === '보험가입' ||
      e.meta.context?.includes('가입일')
    );
    return subscriptionEvent ? subscriptionEvent.date : '미기재';
  }

  findExpirationDate(events) {
    const expirationEvent = events.find(e =>
      e.slots.type === '보험만기' ||
      e.meta.context?.includes('종료일') ||
      e.meta.context?.includes('만기일')
    );
    return expirationEvent ? expirationEvent.date : '미기재';
  }

  calculatePeriod(events) {
    const sub = this.findSubscriptionDate(events);
    const exp = this.findExpirationDate(events);
    if (sub === '미기재' || exp === '미기재') return '미기재';

    const subDate = new Date(sub);
    const expDate = new Date(exp);
    const diffMs = expDate - subDate;
    const years = Math.floor(diffMs / (1000 * 60 * 60 * 24 * 365));
    const months = Math.floor((diffMs % (1000 * 60 * 60 * 24 * 365)) / (1000 * 60 * 60 * 24 * 30));
    return `${years}년 ${months}개월`;
  }

  extractCoverage(dnaResult) {
    const coverageKeywords = ['암보험', '실손보험', '종합보험', '건강보험', '의료보험'];
    const found = [];
    for (const event of dnaResult.events) {
      for (const evidence of event.meta.evidence || []) {
        for (const keyword of coverageKeywords) {
          if (evidence.snippet.includes(keyword) && !found.includes(keyword)) {
            found.push(keyword);
          }
        }
      }
    }
    return found.length > 0 ? found.join(', ') : '미기재';
  }

  extractSpecialTerms(dnaResult) {
    // 특약 관련 키워드 추출
    const specialTermsKeywords = ['특약', '추가보장', '선택특약'];
    // 구현 생략
    return '미기재';
  }
}

// 초기화 시 추가
this.extractors = {
  ...existingExtractors,
  insuranceInfo: new InsuranceInfoExtractor()
};
```

#### 4.3.2 일자별 경과표 정확도 향상

**현재 문제:**
- 날짜 정렬 오류 (페이지 순서 무시)
- 중복 이벤트 제거 불완전
- 이벤트 요약 부정확

**vision OCR 전환 후 개선:**
```javascript
// 1. 좌표 기반 페이지 순서 보존
events.sort((a, b) => {
  // 페이지 우선
  if (a.page !== b.page) return a.page - b.page;

  // 같은 페이지 내에서는 y 좌표 (위→아래)
  const yDiff = a.bbox.y - b.bbox.y;
  if (Math.abs(yDiff) > 0.02) return yDiff;

  // 같은 행이면 x 좌표 (왼쪽→오른쪽)
  return a.bbox.x - b.bbox.x;
});

// 2. 중복 제거 (날짜 + 컨텍스트 유사도)
const deduplicatedEvents = removeDuplicates(events, {
  dateThreshold: 0,  // 날짜 완전 일치
  contextThreshold: 0.8,  // 컨텍스트 80% 유사
  compareSlots: ['diagnosis', 'treatment', 'examination']
});

// 3. 이벤트 요약 (키워드 추출)
function summarizeEvent(event) {
  const keywords = [];
  const prioritySlots = ['diagnosis', 'treatment', 'examination'];

  for (const slot of prioritySlots) {
    if (event.slots[slot] && event.slots[slot] !== '미기재') {
      const keyword = extractKeyKeyword(event.slots[slot]);
      if (keyword) keywords.push(keyword);
    }
  }

  return keywords.slice(0, 5).join(', ');  // 최대 5개 키워드
}
```

---

## 🧪 Phase 5: 7-Phase 후처리 재사용

### 5.1 현재 7-Phase 후처리 구조

**파일:** `backend/eval/cycle5PostProcessing.js`

**7개 Phase 모듈:**
1. **Phase 1: Date Range Validation** (`dateRangeValidator.js`)
   - TOO_OLD (1990년 이전), FUTURE_DATE (현재+30일 초과) 필터링
   - 보험 종료일 특별 처리 (2040년까지 허용)

2. **Phase 2: Type-Based Scoring** (`typeRelevanceScorer.js`)
   - 수술/입원: 100점
   - 보험가입일: 85점 (상향 조정)
   - 의료 이벤트: 60-100점
   - 보험만기일: 15점 (하향 조정)

3. **Phase 3: Recency Scoring** (`recencyScorer.js`)
   - 3개월 이내: 50점
   - 1년 이내: 35점
   - 5년 이내: 20점

4. **Phase 4: Insurance Period Parser** (`insurancePeriodParser.js`)
   - "보험기간 YYYY-MM-DD ~ YYYY-MM-DD" 패턴 파싱
   - 시작일(중요) vs 종료일(낮은 우선순위) 분리

5. **Phase 5: Document Metadata Filter** (`documentMetadataFilter.js`)
   - 발급일, 출력일, 서류작성일 등 73개 메타데이터 날짜 플래그
   - -30점 페널티 적용

6. **Phase 6: Context Analysis** (`contextAnalyzer.js`)
   - 의료 키워드: +25점
   - 문서 키워드: -25점
   - 보험 컨텍스트 수정자 적용

7. **Phase 7: Comprehensive Scoring** (`comprehensiveScorer.js`)
   - 모든 Phase 점수 통합
   - 보험종료일 페널티: -50점
   - 보험가입일 보너스: +10점
   - 빈도 보너스: +10~+20점
   - **필터링 임계값: 20점 이상만 유지**

### 5.2 vision OCR 전환 시 재사용 계획

**입력 어댑터 추가:**
```javascript
/**
 * vision OCR 결과를 7-Phase 입력 형식으로 변환
 */
function adaptOcrTo7PhaseInput(ocrDates, ocrBlocks) {
  return ocrDates.map(date => ({
    date: normalizeDateISO(date.text),
    originalText: date.text,
    page: date.bbox.page,
    bbox: date.bbox,
    context: collectContext(date, ocrBlocks, radius: 0.2),
    type: inferType(date.text, context),  // 정규표현식 기반 타입 추론
    confidence: 1.0
  }));
}
```

**7-Phase 로직 변경 불필요:**
- 입력 형식만 맞추면 그대로 사용 가능
- 점수 계산 로직 동일
- 필터링 임계값 동일 (minScore=20)

---

## 🧪 Phase 6: 테스트 및 검증

### 6.1 단위 테스트

#### 6.1.1 OCR 어댑터 테스트
```typescript
// tests/unit/ocrAdapter.test.ts
describe('ocrAdapter', () => {
  it('should convert vision OCR result to BindInput', () => {
    const ocrResult = loadMockOcrResult();
    const bindInput = adaptOcrToBindInput(ocrResult);

    expect(bindInput.dates).toHaveLength(greaterThan(0));
    expect(bindInput.blocks).toHaveLength(greaterThan(0));
    expect(bindInput.dates[0].bbox).toBeDefined();
  });

  it('should extract dates with over-extraction strategy', () => {
    const blocks = [
      { text: '2023.05.15 CT 촬영', bbox: {...}, page: 1 }
    ];
    const dates = extractDatesWithOverExtraction(blocks);

    expect(dates).toContainEqual(
      expect.objectContaining({ text: '2023.05.15' })
    );
  });
});
```

### 6.2 통합 테스트

#### 6.2.1 E2E 테스트 (Case15 예제)
```typescript
// tests/integration/e2e.test.ts
describe('E2E: vision OCR to 10-item report', () => {
  it('should generate report from Case15 PDF', async () => {
    // 1. PDF → vision OCR
    const ocrResult = await runVisionOcr('Case15.pdf');

    // 2. OCR → BindInput
    const bindInput = adaptOcrToBindInput(ocrResult);

    // 3. Date Binding
    const events = bindDatesToEvents(bindInput);

    // 4. 7-Phase 후처리
    const filtered = await apply7PhasePostProcessing(events);

    // 5. Event Packing
    const packed = packEvents(filtered);

    // 6. 10-item Report
    const report = await generateTenItemReport(packed);

    // 검증
    expect(report.items).toHaveLength(10);
    expect(report.items[9].title).toBe('보험 계약 정보');
    expect(report.timeline).toBeDefined();
  });
});
```

### 6.3 성능 벤치마크

**측정 지표:**

| 지표 | 현재 (visionLLM) | 목표 (vision OCR) | 측정 방법 |
|-----|-----------------|------------------|----------|
| **GT Coverage** | 57% | 65%+ | GT 날짜 중 추출된 비율 |
| **Precision** | 24% | 50%+ | 추출된 날짜 중 GT 비율 |
| **날짜 바인딩 정확도** | 45% | 85%+ | Evidence 매칭 정확도 |
| **이벤트 패킹 정확도** | 60% | 80%+ | 9항목 슬롯 채우기 정확도 |
| **보고서 생성 성공률** | 90% | 95%+ | 에러 없이 생성된 비율 |
| **평균 처리 시간** | 30s/PDF | 20s/PDF | OCR~보고서 생성 전체 |

**벤치마크 스크립트:**
```bash
# 전체 케이스 배치 실행
npm run benchmark:vision-ocr

# 결과 비교 (visionLLM vs vision OCR)
npm run compare:visionllm-vs-visionocr
```

---

## 📅 Phase 7: 롤아웃 계획

### 7.1 단계별 롤아웃 (총 2주)

#### Week 1: 개발 및 단위 테스트
- [ ] Day 1-2: OCR 어댑터 레이어 구현
- [ ] Day 3: 날짜 바인딩 v3 파라미터 튜닝
- [ ] Day 4-5: 표 구조 분석기 구현
- [ ] Day 6: 이벤트 패킹 로직 강화
- [ ] Day 7: 10번째 항목 추가 (보험 정보) + 단위 테스트

#### Week 2: 통합 테스트 및 배포
- [ ] Day 8-9: 5개 샘플 케이스 E2E 테스트
- [ ] Day 10: 성능 벤치마크 실행 및 비교
- [ ] Day 11: 전체 케이스 (50개) 배치 실행
- [ ] Day 12: 실패 케이스 분석 및 개선
- [ ] Day 13: 최종 성능 리포트 작성
- [ ] Day 14: 프로덕션 배포 (기능 플래그 활성화)

### 7.2 성공 기준 (Go/No-Go)

**최소 성공 기준:**
- ✅ GT Coverage ≥ 60%
- ✅ Precision ≥ 40%
- ✅ 날짜 바인딩 정확도 ≥ 75%
- ✅ 보고서 생성 성공률 ≥ 90%
- ✅ 평균 처리 시간 ≤ 30s/PDF

**목표 달성 기준:**
- 🎯 GT Coverage ≥ 65%
- 🎯 Precision ≥ 50%
- 🎯 날짜 바인딩 정확도 ≥ 85%
- 🎯 보고서 생성 성공률 ≥ 95%
- 🎯 평균 처리 시간 ≤ 20s/PDF

### 7.3 위험 관리

**위험 요소 및 대응:**

1. **표 구조 인식 정확도 저하**
   - 완화: 테이블 구조 분석기 추가 구현
   - 대응: visionLLM 하이브리드 모드 (표 페이지만 LLM 사용)

2. **날짜 추출 누락**
   - 완화: 과추출 전략 적용 (Cycle 4 참고)
   - 대응: 7-Phase 후처리로 노이즈 제거

3. **성능 저하 (처리 시간 증가)**
   - 완화: 비동기 처리, 캐싱
   - 대응: 인프라 스케일링

4. **보고서 품질 저하**
   - 완화: 단계별 검증 강화
   - 대응: 롤백 후 하이브리드 시스템 적용

---

## 📝 부록

### A. 참고 파일

| 파일 경로 | 설명 |
|----------|-----|
| `backend/services/visionLLMService.js` | 현재 visionLLM 서비스 |
| `src/lib/ocrParser.ts` | Google Vision OCR 파서 (7개 날짜 패턴) |
| `src/modules/medical-events/service/dateBindingV3.ts` | 날짜 바인딩 v3 (좌표 기반) |
| `src/modules/medical-events/service/eventPacking.ts` | 이벤트 패킹 (9항목) |
| `backend/services/nineItemReportGenerator.js` | 9항목 보고서 생성기 (2,051줄) |
| `backend/eval/cycle5PostProcessing.js` | 7-Phase 후처리 파이프라인 |
| `backend/eval/lib/*.js` | 7개 Phase 모듈 |
| `.trae/documents/offline_ocr 포맷 정밀 매핑·재검증 v1.5 계획.md` | OCR 포맷 매핑 계획 |

### B. 용어 정리

- **visionLLM**: GPT-4o Vision API 기반 OCR 서비스 (좌표 정보 없음)
- **vision OCR**: Google Vision / AWS Textract 등 전통적 OCR 서비스 (좌표 정보 포함)
- **과추출 (Over-extraction)**: 의심스러운 날짜를 모두 추출하는 전략 (Precision 희생, Coverage 향상)
- **7-Phase 후처리**: Cycle 5에서 구현된 7단계 날짜 필터링 파이프라인
- **날짜 바인딩 (Date Binding)**: 날짜와 주변 텍스트를 연결하는 과정 (좌표 기반)
- **이벤트 패킹 (Event Packing)**: 추출된 정보를 9항목 슬롯에 채우는 과정
- **GT (Ground Truth)**: 정답 데이터
- **Coverage**: 정답 중 추출된 비율 (재현율, Recall)
- **Precision**: 추출된 것 중 정답 비율 (정밀도)
- **bbox**: Bounding Box (좌표 정보, {x, y, width, height})

### C. 문서 정보

- **문서 작성자**: Claude Agent
- **작성일**: 2026-01-27
- **버전**: v1.1 (vision OCR 전환 대응)
- **이전 버전**: v1.0 (visionLLM 기반)

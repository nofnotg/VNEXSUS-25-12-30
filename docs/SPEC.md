# SPEC.md - VNEXSUS 의료 AI 분석 시스템 개선 명세서

## 배경/목표

### 배경
- 현재 VNEXSUS 시스템의 프로덕션 준비도 검증 결과 **75% 성공률** (목표: 95%)
- 핵심 기능 중 **고급 날짜 분석**, **의료 키워드 추출**, **텍스트 유사도** 모듈 실패
- 품질 메트릭 **62.5/100점** (목표: 80점 이상)
- 프로덕션 배포를 위한 **즉시 수정 필요** 항목들 존재

### 목표
1. **시스템 안정성 확보**: 500 에러 0건, 95% 이상 성공률 달성
2. **품질 메트릭 개선**: 80점 이상 품질 점수 달성
3. **프로덕션 준비도 완성**: 배포 차단 요소 완전 해결
4. **코드 품질 표준화**: TypeScript strict 모드, 테스트 커버리지 80% 이상

---

## 사용자 스토리 & 수용기준(AC)

### Epic 1: 고급 날짜 분석 모듈 복구
**사용자 스토리**: 의료진이 진료 기록에서 정확한 날짜 정보를 추출하여 시계열 분석을 수행할 수 있다.

**수용기준(AC)**:
- [ ] AC1-1: `/api/advanced-date/analyze` 엔드포인트가 500 에러 없이 정상 작동
- [ ] AC1-2: 한국어 날짜 패턴 (상대적/절대적) 90% 이상 정확도로 추출
- [ ] AC1-3: zod 스키마를 통한 입력 검증 및 타입 안전성 보장
- [ ] AC1-4: 응답 시간 3초 이내, 메모리 사용량 500MB 이하
- [ ] AC1-5: 단위 테스트 커버리지 90% 이상

### Epic 2: 의료 키워드 추출 기능 구현
**사용자 스토리**: 의료진이 진료 기록에서 질병명, 증상, 치료법 등 의료 전문 용어를 자동으로 식별할 수 있다.

**수용기준(AC)**:
- [ ] AC2-1: 의료 도메인 사전 기반 키워드 추출 (최소 1,000개 용어)
- [ ] AC2-2: Fuzzy matching을 통한 오타/변형 용어 인식 (80% 이상 정확도)
- [ ] AC2-3: 컨텍스트 기반 키워드 순위 매기기 및 신뢰도 점수 제공
- [ ] AC2-4: PII/PHI 마스킹 정책 준수 (개인정보 보호)
- [ ] AC2-5: 실시간 처리 성능 (1MB 문서 기준 5초 이내)

### Epic 3: 텍스트 유사도 및 구조화 요약 개선
**사용자 스토리**: 의료진이 여러 진료 기록 간의 유사성을 파악하고 구조화된 요약을 받을 수 있다.

**수용기준(AC)**:
- [ ] AC3-1: 텍스트 유사도 80% 이상 달성 (현재 1.5%)
- [ ] AC3-2: 구조화된 요약 템플릿 적용 (진단명, 치료기간, 병원명 등)
- [ ] AC3-3: ROUGE, BERTScore 등 객관적 품질 메트릭 적용
- [ ] AC3-4: 일관된 출력 형식 및 스키마 표준화
- [ ] AC3-5: 다국어 지원 (한국어, 영어) 및 의료 용어 특화

### Epic 4: 시스템 안정성 및 에러 처리 강화
**사용자 스토리**: 시스템 관리자가 안정적인 서비스 운영과 효과적인 장애 대응을 할 수 있다.

**수용기준(AC)**:
- [ ] AC4-1: 전역 에러 핸들러 구현 및 사용자 친화적 에러 메시지 제공
- [ ] AC4-2: 구조화된 로깅 시스템 (traceId, userId, 마스킹 적용)
- [ ] AC4-3: 서킷 브레이커 패턴 적용 (외부 API 호출 안정성)
- [ ] AC4-4: 헬스체크 엔드포인트 및 모니터링 대시보드
- [ ] AC4-5: 장애 복구 시간 5분 이내, 가용성 99.9% 이상

---

## 스코프/비스코프

### 스코프 (포함 사항)
✅ **즉시 수정 (1-2주)**
- 고급 날짜 분석 모듈 stream 에러 수정
- 의료 키워드 추출 기능 구현
- 텍스트 유사도 알고리즘 개선
- 에러 처리 및 로깅 시스템 구축

✅ **단기 개선 (2-4주)**
- 프로젝트 구조 표준화 (src/modules, src/shared)
- zod 스키마 기반 입력/출력 검증
- Vitest 테스트 프레임워크 설정
- CI/CD 파이프라인 품질 게이트

✅ **중기 최적화 (1-2개월)**
- 성능 최적화 및 메모리 관리
- 임베딩 기반 유사도 개선
- 도메인 특화 프롬프트 엔지니어링

### 비스코프 (제외 사항)
❌ **현재 제외**
- 새로운 AI 모델 훈련/파인튜닝
- 대규모 인프라 변경 (DB, 클라우드 마이그레이션)
- 프론트엔드 UI/UX 대폭 개편
- 다른 도메인(비의료) 확장

---

## API/데이터 계약

### 입력 스키마 (zod 기반)
```typescript
// 고급 날짜 분석
const AdvancedDateRequest = z.object({
  text: z.string().min(1).max(100000),
  options: z.object({
    includeRelative: z.boolean().default(true),
    includeAbsolute: z.boolean().default(true),
    timezone: z.string().default('Asia/Seoul')
  }).optional()
});

// 의료 키워드 추출
const MedicalKeywordRequest = z.object({
  text: z.string().min(1).max(100000),
  options: z.object({
    fuzzyThreshold: z.number().min(0).max(1).default(0.8),
    maxKeywords: z.number().min(1).max(100).default(20),
    includeProbability: z.boolean().default(true)
  }).optional()
});
```

### 출력 스키마
```typescript
// 표준 응답 형식
const StandardResponse = z.object({
  success: z.boolean(),
  data: z.any(),
  error: z.object({
    code: z.string(),
    message: z.string(),
    details: z.any().optional()
  }).optional(),
  metadata: z.object({
    processingTime: z.number(),
    version: z.string(),
    traceId: z.string()
  })
});
```

### 상태코드 정의
- `200`: 성공
- `400`: 잘못된 요청 (스키마 검증 실패)
- `422`: 처리 불가능한 엔티티 (비즈니스 로직 오류)
- `500`: 내부 서버 오류
- `503`: 서비스 일시 불가 (외부 의존성 장애)

---

## 비기능 요구사항

### SLO (Service Level Objectives)
- **가용성**: 99.9% (월 43분 이하 다운타임)
- **응답시간**: P95 < 5초, P99 < 10초
- **처리량**: 초당 100 요청 처리 가능
- **에러율**: < 0.1% (1000 요청 중 1건 이하)

### 보안 요구사항
- PII/PHI 데이터 마스킹 (주민번호, 전화번호, 환자번호)
- HTTPS 통신 강제
- API 키 기반 인증
- 입력 데이터 검증 및 SQL 인젝션 방지

### 접근성
- RESTful API 설계 원칙 준수
- OpenAPI 3.0 스펙 문서 제공
- 다국어 에러 메시지 (한국어, 영어)

### 로깅 요구사항
- 구조화된 JSON 로그 형식
- 민감 정보 자동 마스킹
- 분산 추적 (traceId) 지원
- 로그 레벨별 분류 (ERROR, WARN, INFO, DEBUG)

---

## 테스트 전략

### 단위 테스트 (Unit Tests)
- **도구**: Vitest
- **커버리지**: 80% 이상
- **대상**: 순수 함수, 유틸리티, 서비스 로직
- **실행**: 커밋 전 자동 실행

### 통합 테스트 (Integration Tests)
- **도구**: Vitest + Supertest
- **대상**: API 엔드포인트, 서비스 간 연동
- **환경**: 테스트 컨테이너 또는 Mock 서버
- **실행**: PR 생성 시 자동 실행

### 계약 테스트 (Contract Tests)
- **도구**: Zod 스키마 검증
- **대상**: API 입출력 스키마, 데이터 계약
- **목적**: 하위 호환성 보장
- **실행**: 배포 전 필수 통과

### E2E 테스트 (End-to-End Tests)
- **도구**: Playwright
- **대상**: 핵심 사용자 시나리오
- **환경**: 스테이징 환경
- **실행**: 릴리즈 전 수동/자동 실행

### 성능 테스트
- **도구**: Artillery, K6
- **메트릭**: 응답시간, 처리량, 메모리 사용량
- **기준**: SLO 달성 여부 검증
- **실행**: 주간 정기 실행

---

## 릴리즈/롤백 계획

### 피처 플래그 전략
```typescript
const FEATURE_FLAGS = {
  ADVANCED_DATE_ANALYSIS: 'advanced_date_v2',
  MEDICAL_KEYWORD_EXTRACTION: 'medical_keywords_v1',
  ENHANCED_SIMILARITY: 'similarity_v2'
} as const;
```

### 배포 단계
1. **개발 환경**: 기능 개발 및 단위 테스트
2. **스테이징 환경**: 통합 테스트 및 성능 검증
3. **카나리 배포**: 트래픽 5% 대상 검증
4. **점진적 롤아웃**: 25% → 50% → 100%

### 롤백 기준
- 에러율 > 1%
- 응답시간 P95 > 10초
- 가용성 < 99%
- 비즈니스 크리티컬 기능 장애

### 마이그레이션 계획
- 데이터베이스 스키마 변경 없음 (현재 범위)
- API 버전 관리 (`/api/v1`, `/api/v2`)
- 하위 호환성 6개월 보장

---

## 개발 일정 및 마일스톤

### Week 1-2: 긴급 수정 (Critical Fixes)
- [ ] 고급 날짜 분석 stream 에러 수정
- [ ] 프로젝트 구조 표준화
- [ ] 기본 에러 처리 구현

### Week 3-4: 핵심 기능 구현 (Core Features)
- [ ] 의료 키워드 추출 기능
- [ ] 텍스트 유사도 개선
- [ ] zod 스키마 적용

### Week 5-6: 품질 및 테스트 (Quality & Testing)
- [ ] 테스트 프레임워크 설정
- [ ] 성능 최적화
- [ ] 문서화 완성

### Week 7-8: 배포 준비 (Deployment Ready)
- [ ] CI/CD 파이프라인 구축
- [ ] 모니터링 시스템 설정
- [ ] 프로덕션 배포

---

## 성공 지표 (KPI)

### 기술적 지표
- 시스템 성공률: 75% → 95%
- 품질 점수: 62.5 → 80+ 점
- 응답 시간: 평균 2.3초 → 2초 이하
- 테스트 커버리지: 0% → 80%

### 비즈니스 지표
- 사용자 만족도: 측정 시작
- 처리 정확도: 측정 및 개선
- 시스템 가용성: 99.9% 달성
- 장애 복구 시간: 5분 이내

---

## 위험 요소 및 대응 방안

### 기술적 위험
1. **의존성 충돌**: package-lock.json 고정, 점진적 업데이트
2. **메모리 누수**: 프로파일링 도구 활용, 정기 모니터링
3. **성능 저하**: 벤치마크 테스트, 성능 회귀 방지

### 일정 위험
1. **개발 지연**: 우선순위 조정, MVP 범위 축소
2. **리소스 부족**: 외부 라이브러리 활용, 오픈소스 도구 사용

### 운영 위험
1. **배포 실패**: 롤백 계획 수립, 카나리 배포 적용
2. **데이터 손실**: 백업 전략, 트랜잭션 관리

---

## 승인 및 검토

**작성자**: AI Assistant  
**작성일**: 2025년 1월 25일  
**검토 필요**: 개발팀, 의료진, 시스템 관리자  
**승인 필요**: 프로젝트 매니저, 기술 리더  

**다음 검토 일정**: 매주 금요일 진행 상황 점검
# 보고서 품질 개선 계획

목표: 기존 파이프라인과 UI 버튼을 유지하면서, 보고서(확장/요약) 품질을 단계적으로 향상하고 회귀 없이 검증을 거쳐 릴리즈합니다.

## 1) 배경/현황 요약
- 텍스트 정규화 개선 완료: ICD 코드 교정(`I20).9 → I20.9`, `E1168 → E11.68`, `R074 → R07.4`), 진단 괄호 중복 제거, 병원 카노니컬 매핑(`신촌/강남세브란스 → 세브란스병원`).
- 날짜/연관성/기타 모듈 현황: `dateBlockProcessor.js`, `crossDateCorrelationAnalyzer.js`, `miscCategoryClassifier.js` 존재. 프롬프트 규칙(공개기간/질환별 검사/최종 요약)은 아직 코드로 단일소스화 미완.
- 리포트 생성·미리보기: `npm run report:all`로 CSV/HTML 생성, `http-server`로 페이징·버튼 동작 확인.
- SPEC 현황: 성공률 75%, 품질지표 62.5. 날짜 블록/키워드/유사도 모듈 이슈.

## 2) 품질 목표(KPI)
- 분류 정확도(진단/검사/치료/청구): 85%+
- 날짜 연관/에피소드 연결 정확도: 80%+
- 최종 요약 계약 일치율: 100%
- 회귀 실패율: 0% (필수 테스트 통과)

## 3) 분석/분류 프레임
- 데이터 레이어: 날짜 블록화 → 기타 항목 분류 → 교차 날짜 연관.
- 보고서 레이어: 확장 보고서(진행 차트/근거문구) + 최종 요약(승인자용 포맷).
- 규칙 레이어: 고지의무 공개기간, 질환별 검사 규칙, 요약 필드 계약.

## 4) 개선 항목(우선순위)
1) Claim 섹션 태깅(최우선)
   - 텍스트 내 `[청구사항]` 블록 감지, 해당 블록 내 이벤트에 `isClaim: true` 주입.
   - 동의어: `청구`, `보험`, `수납` 등. 안전장치: 섹션 경계(`[]`, 라인 시작), 혼합 블록 제외.
   - 효과: 의료 이벤트와 청구 이벤트 분리로 분석 정확도 향상.

2) 최종 요약 포맷 계약화
   - 승인자용 요약 필드(방문일/진단/검사/치료/의사소견 등) 키 고정.
   - 하드코딩 제거(i18n key 사용), 스냅샷 계약 테스트.

3) 규칙 단일소스화
   - 공개기간(계약/담보별), 질환별 검사 규칙(협심증/AMI/부정맥/뇌혈관/암), 최종 요약 정의를 상수화.
   - 타입/스키마(zod)로 서비스 경계 검증.

4) 보고서 인터랙션 강화(중기)
   - 정렬/필터/세그먼트 탭, 실패 경로 우선(E2E).

## 5) 상세 구현 계획(단일소스/서비스/계약)
- 상수/타입
  - `src/shared/constants/claimsRules.ts`: 공개기간 윈도우, 질환별 검사 임계값/조합, 요약 필드 키.
  - `src/modules/claims/types/rules.ts`: zod 스키마(DisclosureWindow, DiseaseRule, ReportSummary 등).

- 서비스/룰 엔진
  - `src/modules/claims/service/ruleEngine.ts`: 공개기간 판정, 질환별 검사 해석, 암 일자 시스템(진단/생검/의심/확정) 정규화.

- 포맷터
  - `src/modules/claims/service/reportFormatter.ts`: 확장+요약 동시 출력, i18n 키 사용.

- 파서 연계
  - `scripts/compare-outpatient-episodes-case.js`: `[청구사항]` 섹션 태깅(`isClaim: true`), 기타/의료 항목 분류 결과 반영.

## 6) 테스트/검증 프로세스
- Unit: 공개기간 계산 경계값, 질환 규칙(임계치/조합), 섹션 태깅의 엣지케이스.
- Integration: `dateBlockProcessor ↔ ruleEngine` 경계 검증, 리포트 생성 일관성.
- Contract: `ReportSummary` 스냅샷(Pact 유사), 파괴 방지.
- E2E: 보고서 HTML 페이지 페이징/정렬/필터 버튼 실패 경로(403/토큰만료/중복클릭) 포함.

## 7) 위험 요소 및 대응
- LLM 비결정성: 룰 엔진 우선, LLM은 보조 설명; `temperature` 낮춤, 스냅샷 테스트.
- 문서/코드 불일치: 상수 단일소스화 + 계약 테스트; 변경 시 PR 체크리스트.
- 의료 오판: 반례 포함 테스트와 사용자 검토 플래그 유지.
- PII/PHI: `mask()` 적용, 로그 redacted 필드 기록.
- 성능/비용: 룰은 결정적·경량, LLM 호출은 배치·큐·백오프.

## 8) 단계별 진행 및 게이트
1단계: Claim 섹션 태깅 + 단위/통합 테스트 통과 → 다음 단계 이동
2단계: 최종 요약 계약화 + 스냅샷 테스트 100% → 이동
3단계: 규칙 단일소스화 + 경계 zod 검증 → 이동
4단계: 인터랙션 강화(E2E) → 릴리즈 후보

각 단계 종료 시: `npm run report:all` 생성물 비교, UI 버튼 동작 확인, 테스트 통과 증빙(Log/Report 캡처).

## 9) 영향도 분석(변경 전/후 비교)
- 데이터 계약: 요약 필드 키 변경 금지(신규 필드는 확장으로 추가).
- 파이프라인: 기존 JSON/HTML 출력 경로 유지(`results/`, `reports/`).
- UI: 버튼/페이징 동작 변화 없음(기능 유지), 인터랙션 추가는 별도 플래그로.

## 10) 즉시 실행 항목(이번 스프린트)
- `[청구사항]` 섹션 태깅 구현 및 테스트 5종.
- `ReportSummary` 계약 정의 초안(zod) 및 스냅샷.
- 상수·타입 scaffolding 파일 추가(내용은 점진 보강).

## 11) 참고/연계 문서
- `docs/SPEC.md`, `IMPROVEMENT_PLAN.md`, `종합_개발_진행_리포트.html`
- 프롬프트: `고지의무위반 프롬프트*.txt`, `손해사정 보고서 프롬프트.txt`, `최종보고용요약규칙.txt`, `질환별 검사결과 적용교칙 통합버전.txt`


# VNEXSUS 자가학습 시스템 고도화 개발계획서

## 📋 개요

본 문서는 `25-10-07_dev`와 `25-10-07-1_dev` 개발 문서를 기반으로 VNEXSUS 자가학습 시스템의 고도화 방향을 제시합니다.

---

## 🎯 핵심 고도화 목표

### 1. 문서 템플릿 마이닝 시스템 구축
- **목적**: 병원별 보일러플레이트 자동 추출 및 캐시 시스템
- **효과**: 문서 처리 정확도 향상 및 노이즈 제거

### 2. 적응형 선행귀속(Adaptive Leading Attachment) 시스템
- **목적**: 문맥 기반 동적 윈도우 조정
- **효과**: 관련 정보의 정확한 연결 및 분석

### 3. 트렁크(Trunk) 기반 우선순위 분류 시스템
- **목적**: 핵심 의료 이벤트(암/뇌/심장/사망/수술/MRI) 우선 처리
- **효과**: 중요 정보의 신속한 식별 및 처리

---

## 🏗️ 단계별 개발 계획

## Phase 1: 문서 템플릿 마이닝 시스템 (4주)

### 1.1 보일러플레이트 추출 엔진 개발
```typescript
// src/template/layoutMiner.ts
export function mineBoilerplate(pages: Page[]): BoilerplatePattern {
  // 페이지별 공통 패턴 추출
  // 헤더/푸터/사이드바 식별
  // 반복 패턴 점수화
}

export function stripBoilerplate(pages: Page[], pattern: BoilerplatePattern): Page[] {
  // 보일러플레이트 제거
  // 핵심 콘텐츠만 추출
}
```

### 1.2 병원별 템플릿 캐시 시스템
```typescript
// src/template/cache.ts
export class TemplateCache {
  updateTemplate(hospitalId: string, template: Template): void
  getTemplate(hospitalId: string): Template | null
  getTemplateConfidence(hospitalId: string): number
  inferTemplateId(hospitalName: string, docTitle: string): string
}
```

### 1.3 개발 작업
- [ ] `mineBoilerplate` 함수 구현
- [ ] `stripBoilerplate` 함수 구현
- [ ] `lineScore` 알고리즘 개발
- [ ] 병원별 템플릿 캐시 DB 설계
- [ ] 템플릿 신뢰도 계산 로직 구현

---

## Phase 2: 적응형 선행귀속 시스템 (3주)

### 2.1 동적 윈도우 조정 시스템
```typescript
// src/segment/adaptiveLeading.ts
export function leadingWindowFor(templateId: string, segmentType: string): number {
  // 템플릿별 최적 윈도우 크기 계산
  // 세그먼트 타입별 가중치 적용
}

export function sliceWithAdaptiveLeading(lines: string[], anchor: number, templateId: string): string[] {
  // 적응형 선행 슬라이싱
  // 문맥 기반 동적 조정
}
```

### 2.2 세그먼트 분할 및 날짜 블록 처리
```typescript
// src/segment/dateBlocker.ts
export function splitSegments(lines: string[]): Segment[]
export function toDateBlocks(segment: Segment): DateBlock[]
export function adjustLeading(block: DateBlock, context: Context): DateBlock
```

### 2.3 개발 작업
- [ ] 적응형 윈도우 크기 계산 알고리즘 구현
- [ ] 세그먼트 분할 로직 개발
- [ ] 날짜 앵커 기반 블록 생성 시스템
- [ ] 선행/후행 귀속 규칙 엔진 구현

---

## Phase 3: 트렁크 분류 및 우선순위 시스템 (3주)

### 3.1 트렁크 분류기 개발
```typescript
// src/rules/trunkClassifier.ts
export enum TrunkType {
  DEATH = "DEATH",
  CANCER = "CANCER", 
  NEURO = "NEURO",
  CARDIO = "CARDIO",
  HEPATIC = "HEPATIC",
  SURGERY = "SURGERY",
  ADMISSION = "ADMISSION",
  EXAM = "EXAM"
}

export function trunkOf(event: MedicalEvent): TrunkType
export function trunkScore(event: MedicalEvent): number
```

### 3.2 링크 가중치 시스템
```yaml
# config/linking.yml
trunk_weights:
  CANCER: 
    test_to_treat_days: +10
    weight: +0.3
  NEURO:
    suspect_to_test_days: +7
    weight: +0.2
  CARDIO:
    test_to_treat_days: +7
    weight: +0.2
  DEATH:
    follow_to_close_days: +30
    weight: +0.5
```

### 3.3 개발 작업
- [ ] 트렁크 분류 룰 엔진 구현
- [ ] 의료 코드 기반 자동 분류 시스템
- [ ] 링크 가중치 계산 알고리즘
- [ ] YAML 기반 설정 관리 시스템

---

## Phase 4: PII 보호 및 정보 보존 시스템 (2주)

### 4.1 최소 삭제 PII 스크러버
```typescript
// src/clean/piiScrubber.ts
export function scrubMinimal(lines: string[]): string[] {
  // PII 식별 및 태깅 (삭제 대신)
  // 의료 정보 보존
  // 감사 추적 가능한 마스킹
}
```

### 4.2 개발 작업
- [ ] PII 패턴 인식 시스템 구현
- [ ] 정보 보존형 태깅 시스템
- [ ] 감사 추적 메타데이터 생성

---

## Phase 5: AI 전처리 및 룰엔진 통합 (4주)

### 5.1 전처리 AI 프롬프트 시스템
```typescript
// src/preprocess/callPreAI.ts
export interface DataContractV1 {
  events: MedicalEvent[]
  hospital: HospitalInfo
  visitType: VisitType
  dx: DiagnosisInfo[]
  tests: TestInfo[]
  procedures: ProcedureInfo[]
  meds: MedicationInfo[]
  notes: NoteInfo
  evidence: EvidenceSpan[]
  flags: string[]
}
```

### 5.2 룰엔진 통합 시스템
```typescript
// src/rules/engine.ts
export function runRuleEngine(preDoc: DataContractV1, config: RuleConfig): ProcessedDocument
export function canonicalize(rawData: any): CanonicalData
export function linkEvents(events: MedicalEvent[]): LinkedEvent[]
export function createEpisodes(linkedEvents: LinkedEvent[]): Episode[]
```

### 5.3 개발 작업
- [ ] AI 전처리 프롬프트 엔진 구현
- [ ] 데이터 계약 스키마 정의
- [ ] 룰엔진 통합 시스템 구현
- [ ] 링크 및 에피소드 생성 로직

---

## Phase 6: 보고서 생성 및 시각화 (3주)

### 6.1 9항목 보고서 시스템
- 에피소드 인덱스 (통원 회수/핵심행위)
- 링크 가시화 (test#3, treat#5)
- 동일일자 다건 병합 표기
- 근거 스팬 하이라이트

### 6.2 개발 작업
- [ ] 보고서 템플릿 엔진 구현
- [ ] 에피소드 인덱스 생성 시스템
- [ ] 링크 시각화 컴포넌트
- [ ] 근거 스팬 하이라이트 기능

---

## 🔧 기술 스택 및 아키텍처

### 백엔드 확장
```
src/
├── template/
│   ├── layoutMiner.ts      # 보일러플레이트 마이닝
│   └── cache.ts           # 템플릿 캐시 시스템
├── segment/
│   ├── adaptiveLeading.ts  # 적응형 선행귀속
│   └── dateBlocker.ts     # 날짜 블록 처리
├── rules/
│   ├── trunkClassifier.ts  # 트렁크 분류기
│   └── engine.ts          # 룰엔진 통합
├── clean/
│   └── piiScrubber.ts     # PII 보호 시스템
└── preprocess/
    └── callPreAI.ts       # AI 전처리 시스템
```

### 설정 관리
```
config/
├── linking.yml            # 링크 가중치 설정
├── templates.yml          # 템플릿 설정
└── features.yml           # 기능 플래그
```

### 프롬프트 관리
```
prompts/
├── PRE_AI_SYSTEM@v2.txt   # 시스템 프롬프트
└── PRE_AI_USER@v2.hbs     # 사용자 프롬프트 템플릿
```

---

## 📊 성능 및 품질 지표

### 성능 목표
- **문서 처리 속도**: 50% 향상
- **정확도**: 85% → 95% 향상
- **노이즈 제거율**: 90% 이상

### 품질 관리
- **회귀 테스트**: 30문서 파일럿 세트
- **모니터링**: 실시간 품질 지표 추적
- **A/B 테스트**: 기존 vs 고도화 시스템 비교

---

## 🚀 배포 및 운영 계획

### Feature Flags 기반 점진적 배포
```yaml
# config/features.yml
template_mining: true      # 템플릿 마이닝 활성화
adaptive_leading: true     # 적응형 선행귀속 활성화  
trunk_boost: true         # 트렁크 부스트 활성화
ai_preprocess: false      # AI 전처리 (단계적 활성화)
```

### 모니터링 및 알림
- 실시간 성능 대시보드
- 오류율 임계값 알림
- 품질 지표 자동 리포팅

---

## 📅 전체 일정

| Phase | 기간 | 주요 작업 | 완료 기준 |
|-------|------|-----------|-----------|
| Phase 1 | 4주 | 템플릿 마이닝 시스템 | 보일러플레이트 90% 제거 |
| Phase 2 | 3주 | 적응형 선행귀속 | 문맥 연결 정확도 85% |
| Phase 3 | 3주 | 트렁크 분류 시스템 | 핵심 이벤트 95% 식별 |
| Phase 4 | 2주 | PII 보호 시스템 | 정보 손실 5% 미만 |
| Phase 5 | 4주 | AI-룰엔진 통합 | 전체 파이프라인 통합 |
| Phase 6 | 3주 | 보고서 시각화 | 사용자 만족도 90% |

**총 개발 기간: 19주 (약 5개월)**

---

## 🎯 기대 효과

### 정량적 효과
- **처리 속도**: 50% 향상
- **정확도**: 10% 향상 (85% → 95%)
- **노이즈 제거**: 90% 이상
- **개발 생산성**: 30% 향상

### 정성적 효과
- 병원별 맞춤형 처리 가능
- 의료진 업무 효율성 증대
- 의료 데이터 품질 향상
- 확장 가능한 아키텍처 구축

---

## ⚠️ 리스크 및 대응 방안

### 기술적 리스크
- **AI 모델 성능 변동**: 다중 모델 백업 및 폴백 시스템
- **대용량 데이터 처리**: 분산 처리 및 캐싱 전략
- **레거시 시스템 호환성**: 점진적 마이그레이션 계획

### 운영적 리스크  
- **사용자 적응**: 단계적 교육 및 지원
- **데이터 보안**: 강화된 PII 보호 및 감사 시스템
- **성능 저하**: 실시간 모니터링 및 자동 스케일링

---

## 📞 결론

본 고도화 계획은 VNEXSUS 자가학습 시스템의 핵심 기능을 대폭 향상시켜 의료 문서 처리의 정확도와 효율성을 크게 개선할 것입니다. 단계적 접근과 Feature Flags를 통한 안전한 배포로 리스크를 최소화하면서 최대 효과를 달성할 수 있을 것으로 기대됩니다.